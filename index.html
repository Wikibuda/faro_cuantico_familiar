<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåå Faro Cu√°ntico Familiar - Sistema M√°gico Completo</title>
    <style>
        :root {
            --color-magico: #ff6b6b;
            --color-agua: #4ecdc4;
            --color-tiempo: #45b7d1;
            --color-sue√±o: #96ceb4;
            --color-sabiduria: #feca57;
            --color-purpura: #a78bfa;
            --color-rosa: #f9a8d4;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* EFECTO DE PART√çCULAS M√ÅGICAS */
        .particulas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .particula {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--color-agua);
            border-radius: 50%;
            animation: flotar 8s infinite linear;
        }
        
        @keyframes flotar {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }
        
        /* NAVEGACI√ìN M√ÅGICA */
        .navegacion-cuantica {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(15, 12, 41, 0.95);
            padding: 15px 20px;
            z-index: 1000;
            backdrop-filter: blur(20px);
            border-bottom: 3px solid var(--color-magico);
            box-shadow: 0 5px 25px rgba(255, 107, 107, 0.3);
        }
        
        .botones-navegacion {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .boton-modulo {
            background: linear-gradient(135deg, rgba(255,107,107,0.2), rgba(78,205,196,0.2));
            color: white;
            border: 2px solid transparent;
            padding: 14px 24px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 16px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .boton-modulo::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .boton-modulo:hover::before {
            left: 100%;
        }
        
        .boton-modulo:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
            border-color: var(--color-magico);
        }
        
        .boton-modulo.activo {
            background: linear-gradient(135deg, var(--color-magico), var(--color-rosa));
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.6);
            transform: scale(1.05);
        }
        
        /* M√ìDULOS PRINCIPALES */
        .modulo {
            display: none;
            padding: 100px 20px 40px;
            min-height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            animation: aparecer 0.6s ease-out;
        }
        
        .modulo.activo {
            display: block;
        }
        
        @keyframes aparecer {
            from { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        /* TARJETAS M√ÅGICAS */
        .tarjeta-cuantica {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border-radius: 25px;
            padding: 30px;
            margin: 25px 0;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.15);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .tarjeta-cuantica::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--color-magico), var(--color-agua), var(--color-sabiduria));
        }
        
        .tarjeta-cuantica:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.3);
        }
        
        /* ESTAD√çSTICAS VIVAS */
        .estadistica-viva {
            font-size: 3.5em;
            font-weight: 800;
            text-align: center;
            margin: 15px 0;
            background: linear-gradient(45deg, var(--color-magico), var(--color-agua), var(--color-purpura));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% 200%;
            animation: brilloArcoiris 3s ease-in-out infinite alternate;
            text-shadow: 0 0 30px rgba(255,107,107,0.3);
        }
        
        @keyframes brilloArcoiris {
            0% { background-position: 0% 50%; filter: hue-rotate(0deg); }
            100% { background-position: 100% 50%; filter: hue-rotate(360deg); }
        }
        
        /* GRID MODERNO */
        .grid-estadisticas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        
        .grid-cuentos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        /* CUENTO CARDS */
        .cuento-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
            border-radius: 20px;
            padding: 20px;
            border-left: 5px solid var(--color-magico);
            transition: all 0.3s ease;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .cuento-card:hover {
            transform: translateY(-5px);
            border-left-color: var(--color-agua);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .cuento-card h4 {
            color: var(--color-agua);
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        /* FILTROS INTERACTIVOS */
        .filtros-contenedor {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .filtro-categoria {
            background: rgba(255,255,255,0.1);
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            backdrop-filter: blur(10px);
        }
        
        .filtro-categoria:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }
        
        .filtro-categoria.activo {
            background: linear-gradient(135deg, var(--color-magico), var(--color-rosa));
            box-shadow: 0 5px 15px rgba(255,107,107,0.4);
        }
        
        /* BOTONES DE ACCI√ìN */
        .boton-accion {
            background: linear-gradient(135deg, var(--color-agua), var(--color-tiempo));
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            box-shadow: 0 5px 15px rgba(78,205,196,0.3);
        }
        
        .boton-accion:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(78,205,196,0.5);
        }
        
        /* ESCENAS INTERACTIVAS */
        .escena-interactiva {
            background: linear-gradient(135deg, rgba(15,12,41,0.8), rgba(48,43,99,0.8));
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid var(--color-purpura);
            position: relative;
        }
        
        .escena-interactiva::before {
            content: '‚ú®';
            position: absolute;
            top: -15px;
            left: 20px;
            font-size: 1.5em;
            background: var(--color-purpura);
            padding: 5px 10px;
            border-radius: 15px;
        }
        
        /* PROGRESS BAR M√ÅGICO */
        .barra-progreso {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progreso {
            height: 100%;
            background: linear-gradient(90deg, var(--color-magico), var(--color-rosa));
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .progreso::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: brilloProgreso 2s infinite;
        }
        
        @keyframes brilloProgreso {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* LOGROS Y RECOMPENSAS */
        .logro {
            background: linear-gradient(135deg, rgba(254,202,87,0.2), rgba(255,217,61,0.1));
            border: 2px solid var(--color-sabiduria);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logro-icono {
            font-size: 2em;
            background: var(--color-sabiduria);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .botones-navegacion {
                flex-direction: column;
                align-items: center;
            }
            
            .boton-modulo {
                width: 100%;
                max-width: 300px;
            }
            
            .grid-estadisticas {
                grid-template-columns: 1fr;
            }
            
            .estadistica-viva {
                font-size: 2.5em;
            }
        }
        
        /* EFECTOS ESPECIALES */
        .brillo-texto {
            text-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor;
        }
        
        .latido {
            animation: latido 2s ease-in-out infinite;
        }
        
        @keyframes latido {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* BUSCADOR */
        #buscador-cuentos {
            padding: 12px 20px;
            border-radius: 25px;
            border: 2px solid var(--color-agua);
            background: rgba(255,255,255,0.1);
            color: white;
            width: 100%;
            max-width: 500px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        #buscador-cuentos:focus {
            border-color: var(--color-magico);
            box-shadow: 0 0 15px rgba(255,107,107,0.3);
        }

        /* NOTIFICACIONES */
        #notificaciones {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
        }

        /* ANIMACIONES PARA ESTAD√çSTICAS */
        @keyframes contar {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .contador-animado {
            animation: contar 0.6s ease-in-out;
        }

        .contador-favoritos {
            background: var(--color-sabiduria) !important;
            color: #0f0c29 !important;
            padding: 2px 8px !important;
            border-radius: 10px !important;
            font-size: 0.8em !important;
            margin-left: 5px !important;
            font-weight: bold !important;
            animation: latido 2s ease-in-out infinite !important;
        }

        /* =========================================== */
        /* ESTILOS RESPONSIVE PARA M√ìVILES */
        /* =========================================== */
        
        /* Bot√≥n hamburguesa */
        .boton-hamburguesa {
            display: none;
            flex-direction: column;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 10px;
            gap: 4px;
            z-index: 2001;
            position: relative;
        }
        
        .boton-hamburguesa span {
            width: 25px;
            height: 3px;
            background: var(--color-agua);
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        
        .boton-hamburguesa.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }
        
        .boton-hamburguesa.active span:nth-child(2) {
            opacity: 0;
        }
        
        .boton-hamburguesa.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }
        
        /* Logo para m√≥viles */
        .logo-movil {
            display: none;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--color-agua);
        }
        
        /* Men√∫ m√≥vil */
        .menu-movil {
            display: block;
            position: fixed;
            top: 0;
            right: -100%;
            width: 280px;
            height: 100vh;
            background: rgba(15, 12, 41, 0.98);
            backdrop-filter: blur(20px);
            z-index: 2000;
            transition: right 0.3s ease;
            border-left: 3px solid var(--color-magico);
            box-shadow: -5px 0 25px rgba(0,0,0,0.5);
        }
        
        .menu-movil.active {
            right: 0;
        }
        
        .menu-contenido {
            padding: 80px 20px 20px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .boton-modulo-movil {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 2px solid transparent;
            padding: 16px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: left;
            backdrop-filter: blur(10px);
        }
        
        .boton-modulo-movil:hover {
            background: rgba(255,255,255,0.2);
            border-color: var(--color-magico);
            transform: translateX(5px);
        }
        
        .boton-modulo-movil.activo {
            background: linear-gradient(135deg, var(--color-magico), var(--color-rosa));
            box-shadow: 0 5px 15px rgba(255,107,107,0.4);
        }
        
        /* Overlay para cerrar men√∫ */
        .overlay-menu {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .overlay-menu.active {
            display: block;
            opacity: 1;
        }
        
        /* =========================================== */
        /* MEDIA QUERIES PARA RESPONSIVE */
        /* =========================================== */
        
        @media (max-width: 768px) {
            /* Ocultar men√∫ desktop en m√≥viles */
            .menu-desktop {
                display: none;
            }
            
            /* Mostrar hamburguesa y logo */
            .boton-hamburguesa {
                display: flex;
            }
            
            .logo-movil {
                display: block;
                margin-left: 10px;
            }
            
            /* Ajustar navegaci√≥n para m√≥viles */
            .navegacion-cuantica {
                padding: 12px 15px;
            }
            
            .botones-navegacion {
                justify-content: space-between;
            }
            
            /* Ajustar padding de m√≥dulos para m√≥viles */
            .modulo {
                padding: 80px 15px 30px;
            }
            
            /* Ajustar grid para m√≥viles */
            .grid-estadisticas {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .grid-cuentos {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            /* Ajustar tarjetas para m√≥viles */
            .tarjeta-cuantica {
                padding: 20px;
                margin: 15px 0;
            }
            
            .estadistica-viva {
                font-size: 2.8em;
            }
            
            /* Ajustar botones para m√≥viles */
            .boton-accion {
                padding: 12px 18px;
                font-size: 14px;
                width: 100%;
                margin: 3px 0;
            }
            
            /* Ajustar filtros para m√≥viles */
            .filtros-contenedor {
                gap: 8px;
            }
            
            .filtro-categoria {
                padding: 10px 15px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            /* Ajustes para pantallas muy peque√±as */
            .modulo {
                padding: 70px 10px 20px;
            }
            
            .tarjeta-cuantica {
                padding: 15px;
                margin: 10px 0;
            }
            
            .estadistica-viva {
                font-size: 2.2em;
            }
            
            .filtro-categoria {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .menu-movil {
                width: 250px;
            }
        }
        
        /* Para tablets (mantener men√∫ desktop) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .menu-desktop {
                display: flex;
            }
            
            .boton-hamburguesa {
                display: none;
            }
            
            .logo-movil {
                display: none;
            }
            
            /* Ajustar botones para tablets */
            .boton-modulo {
                padding: 12px 18px;
                font-size: 14px;
            }
        }

    </style>
</head>
<body>
    <!-- SISTEMA DE PART√çCULAS M√ÅGICAS -->
    <div class="particulas" id="particulas"></div>

    <!-- NAVEGACI√ìN M√ÅGICA RESPONSIVE -->
    <nav class="navegacion-cuantica">
        <div class="botones-navegacion">
            <!-- Bot√≥n hamburguesa para m√≥viles -->
            <button class="boton-hamburguesa" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <!-- Logo/T√≠tulo para m√≥viles -->
            <div class="logo-movil">
                üåå Faro Cu√°ntico
            </div>
            
            <!-- Men√∫ normal para desktop -->
            <div class="menu-desktop">
                <button class="boton-modulo activo" onclick="cambiarModulo('dashboard')">üåå Dashboard</button>
                <button class="boton-modulo" onclick="cambiarModulo('biblioteca')">üìö Biblioteca</button>
                <button class="boton-modulo" onclick="cambiarModulo('analizador')">üß† Analizador</button>
                <button class="boton-modulo" onclick="cambiarModulo('interactivo')">üé≠ Interactivo</button>
                <button class="boton-modulo" onclick="cambiarModulo('tutor')">üë∂ Mi Aprendizaje</button>
            </div>
            
            <!-- Men√∫ m√≥vil (oculto por defecto) -->
            <div class="menu-movil" id="menuMovil">
                <div class="menu-contenido">
                    <button class="boton-modulo-movil activo" onclick="cambiarModuloMovil('dashboard')">üåå Dashboard</button>
                    <button class="boton-modulo-movil" onclick="cambiarModuloMovil('biblioteca')">üìö Biblioteca</button>
                    <button class="boton-modulo-movil" onclick="cambiarModuloMovil('analizador')">üß† Analizador</button>
                    <button class="boton-modulo-movil" onclick="cambiarModuloMovil('interactivo')">üé≠ Interactivo</button>
                    <button class="boton-modulo-movil" onclick="cambiarModuloMovil('tutor')">
                        üë∂ Mi Aprendizaje
                        <span class="contador-favoritos" style="display: none;"></span>
                    </button>

                </div>
            </div>
        </div>
    </nav>

    <!-- Overlay para cerrar men√∫ m√≥vil -->
    <div class="overlay-menu" onclick="toggleMenu()"></div>

    <!-- M√ìDULO 1: DASHBOARD PRINCIPAL EPICO -->
    <div id="dashboard" class="modulo activo">
        <div style="text-align: center; margin-bottom: 50px;">
            <h1 style="font-size: 3.5em; margin-bottom: 10px; background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #feca57); -webkit-background-clip: text; -webkit-text-fill-color: transparent;" class="latido">
                üåå Faro Cu√°ntico Familiar
            </h1>
            <p style="font-size: 1.3em; opacity: 0.9;">Donde los cuentos cobran vida y la magia es real</p>
        </div>

        <!-- ESTAD√çSTICAS PRINCIPALES DIN√ÅMICAS -->
        <div class="grid-estadisticas">
            <div class="tarjeta-cuantica" style="text-align: center;">
                <h3>üìö Universos Activados</h3>
                <div class="estadistica-viva" id="contador-cuentos">33</div>
                <p>cuentos m√°gicos cargados</p>
                <div class="barra-progreso">
                    <div class="progreso" style="width: 100%"></div>
                </div>
            </div>
            
            <div class="tarjeta-cuantica" style="text-align: center;">
                <h3>üîÆ Palabras M√°gicas</h3>
                <div class="estadistica-viva" id="contador-palabras">7,731</div>
                <p>vocablos de poder acumulados</p>
                <div class="barra-progreso">
                    <div class="progreso" style="width: 95%"></div>
                </div>
            </div>
            
            <div class="tarjeta-cuantica" style="text-align: center;">
                <h3>üé≠ Arquetipos Detectados</h3>
                <div class="estadistica-viva" id="contador-arquetipos">8</div>
                <p>patrones universales identificados</p>
                <div class="barra-progreso">
                    <div class="progreso" style="width: 70%"></div>
                </div>
            </div>
            
            <div class="tarjeta-cuantica" style="text-align: center;">
                <h3>üë∂ Nivel de Magia</h3>
                <div class="estadistica-viva">‚àû</div>
                <p>potencial de aprendizaje infinito</p>
                <div class="barra-progreso">
                    <div class="progreso" style="width: 100%"></div>
                </div>
            </div>
        </div>

        <!-- ACCIONES R√ÅPIDAS -->
        <div class="tarjeta-cuantica">
            <h2 style="text-align: center; margin-bottom: 25px;">üöÄ Acciones M√°gicas</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <button class="boton-accion" onclick="cambiarModulo('biblioteca')" style="background: linear-gradient(135deg, var(--color-agua), var(--color-tiempo));">
                    üìñ Explorar Biblioteca Completa
                </button>
                <button class="boton-accion" onclick="cambiarModulo('analizador')" style="background: linear-gradient(135deg, var(--color-purpura), var(--color-rosa));">
                    üß† Ver An√°lisis Profundo
                </button>
                <button class="boton-accion" onclick="iniciarAventuraCompleta()" style="background: linear-gradient(135deg, var(--color-magico), var(--color-sabiduria));">
                    üé≠ Comenzar Aventura Interactiva
                </button>
                <button class="boton-accion" onclick="cambiarModulo('tutor')" style="background: linear-gradient(135deg, var(--color-sue√±o), var(--color-agua));">
                    üë∂ Ver Mi Progreso
                </button>
            </div>
        </div>

        <!-- CUENTOS DESTACADOS -->
        <div class="tarjeta-cuantica">
            <h2 style="text-align: center; margin-bottom: 25px;">‚≠ê Cuentos √âpicos Destacados</h2>
            <div class="grid-cuentos">
                <div class="cuento-card" style="border-left: 5px solid var(--color-sabiduria);">
                    <h4>üåü El Faro</h4>
                    <p>üìä <strong>462 palabras</strong> | üè∑Ô∏è üåä Elementos Acu√°ticos</p>
                    <p>El cuento que da nombre y alma a nuestro universo</p>
                    <button class="boton-accion" onclick="leerCuentoCompleto('El Faro')" 
                            style="padding: 10px 15px; font-size: 14px; margin-top: 10px;
                                   background: linear-gradient(135deg, var(--color-sabiduria), var(--color-purpura));">
                        üìñ Leer el Cuento Maestro
                    </button>
                </div>
                
                <div class="cuento-card">
                    <h4>üèÜ La Casa de los Telares</h4>
                    <p>üìä <strong>853 palabras</strong> | üè∑Ô∏è üåä Elementos Acu√°ticos</p>
                    <p>El cuento m√°s extenso y complejo de la colecci√≥n</p>
                    <button class="boton-accion" onclick="leerCuentoCompleto('La Casa de los Telares')" style="padding: 10px 15px; font-size: 14px; margin-top: 10px;">
                        üìñ Leer Ahora
                    </button>
                </div>
                
                <div class="cuento-card">
                    <h4>üßµ La Tejedora del Valle</h4>
                    <p>üìä <strong>781 palabras</strong> | üè∑Ô∏è üßµ Tejedor de Realidades</p>
                    <p>Magia, transformaci√≥n y creaci√≥n de mundos</p>
                    <button class="boton-accion" onclick="leerCuentoCompleto('La Tejedora del Valle')" style="padding: 10px 15px; font-size: 14px; margin-top: 10px;">
                        üìñ Leer Ahora
                    </button>
                </div>
            </div>
        </div>

        <!-- MENSAJE DEL NI√ëO -->
        <div class="tarjeta-cuantica" style="background: linear-gradient(135deg, rgba(249,168,212,0.2), rgba(167,139,250,0.2)); border-color: var(--color-rosa);">
            <div style="text-align: center;">
                <h3 style="color: var(--color-rosa); margin-bottom: 15px;">üë∂ Mensaje M√°gico</h3>
                <p style="font-size: 1.2em; font-style: italic;" id="mensaje-ni√±o">"Cargando la sabidur√≠a de los cuentos..."</p>
                <div style="margin-top: 15px; font-size: 0.9em; opacity: 0.8;">
                    üí´ El Faro Cu√°ntico est√° listo para la aventura
                </div>
            </div>
        </div>
    </div>

    <!-- M√ìDULO 2: BIBLIOTECA INTERACTIVA COMPLETA -->
    <div id="biblioteca" class="modulo">
        <h1 style="text-align: center; margin-bottom: 30px; background: linear-gradient(45deg, var(--color-agua), var(--color-tiempo)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            üìö Biblioteca Cu√°ntica Interactiva
        </h1>
        
        <!-- FILTROS M√ÅGICOS -->
        <div class="tarjeta-cuantica">
            <h3 style="text-align: center; margin-bottom: 20px;">üîç Filtros M√°gicos</h3>
            <div class="filtros-contenedor">
                <div class="filtro-categoria activo" onclick="filtrarBiblioteca('todos')">üìö Todos (33)</div>
                <div class="filtro-categoria" onclick="filtrarBiblioteca('agua')">üåä Acu√°ticos (10)</div>
                <div class="filtro-categoria" onclick="filtrarBiblioteca('mujer')">üë© Sabidur√≠a Femenina (5)</div>
                <div class="filtro-categoria" onclick="filtrarBiblioteca('tejedor')">üßµ Tejedores (3)</div>
                <div class="filtro-categoria" onclick="filtrarBiblioteca('artesano')">üõ†Ô∏è Artesanos (6)</div>
                <div class="filtro-categoria" onclick="filtrarBiblioteca('sastre')">üëó Sastres (2)</div>
                <div class="filtro-categoria" onclick="filtrarBiblioteca('faro')">üí° Fareros (2)</div>
            </div>
            
            <!-- BARRA DE B√öSQUEDA -->
            <div style="text-align: center; margin-top: 20px;">
                <input type="text" id="buscador-cuentos" placeholder="üîç Buscar por t√≠tulo, contenido, categor√≠a o tema..." 
                       style="padding: 12px 20px; border-radius: 25px; border: 2px solid var(--color-agua); 
                              background: rgba(255,255,255,0.1); color: white; width: 100%; max-width: 500px;
                              font-size: 16px; outline: none; transition: all 0.3s ease;"
                       onfocus="this.style.borderColor='var(--color-magico)'; this.style.boxShadow='0 0 15px rgba(255,107,107,0.3)';"
                       onblur="this.style.borderColor='var(--color-agua)'; this.style.boxShadow='none';">
            </div>            
        </div>

        <!-- COLECCI√ìN COMPLETA -->
        <div class="tarjeta-cuantica">
            <h3 style="text-align: center; margin-bottom: 25px;">üìñ Colecci√≥n Completa de Universos</h3>
            <div class="grid-cuentos" id="lista-cuentos-completa">
                <!-- Los cuentos se cargan aqu√≠ m√°gicamente -->
            </div>
        </div>
    </div>

    <!-- M√ìDULO 3: ANALIZADOR PROFUNDO -->
    <div id="analizador" class="modulo">
        <h1 style="text-align: center; margin-bottom: 30px; background: linear-gradient(45deg, var(--color-purpura), var(--color-rosa)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            üß† Analizador de Patrones M√°gicos
        </h1>
        
        <!-- RESUMEN DEL AN√ÅLISIS -->
        <div class="tarjeta-cuantica">
            <h3 style="text-align: center; margin-bottom: 25px;">üìä Resumen del An√°lisis Cu√°ntico</h3>
            <div class="grid-estadisticas" id="resumen-analisis">
                <!-- An√°lisis se carga aqu√≠ -->
            </div>
        </div>

        <!-- DETALLES DEL AN√ÅLISIS -->
        <div class="grid-estadisticas">
            <div class="tarjeta-cuantica">
                <h4 style="text-align: center; color: var(--color-magico);">üé≠ Arquetipos Detectados</h4>
                <div id="arquetipos-lista" style="margin-top: 15px;"></div>
            </div>
            
            <div class="tarjeta-cuantica">
                <h4 style="text-align: center; color: var(--color-agua);">üíñ Emociones en los Cuentos</h4>
                <div id="emociones-lista" style="margin-top: 15px;"></div>
            </div>
            
            <div class="tarjeta-cuantica">
                <h4 style="text-align: center; color: var(--color-sabiduria);">üìñ Estructuras Narrativas</h4>
                <div id="estructuras-lista" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <!-- M√ìDULO 4: CUENTOS INTERACTIVOS √âPICOS -->
    <div id="interactivo" class="modulo">
        <h1 style="text-align: center; margin-bottom: 30px; background: linear-gradient(45deg, var(--color-magico), var(--color-sabiduria)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            üé≠ Taller de Realidades Interactivas
        </h1>
        
        <div class="tarjeta-cuantica">
            <h3 style="text-align: center; margin-bottom: 20px;">üåå Elige Tu Aventura</h3>
            <p style="text-align: center; margin-bottom: 25px; font-size: 1.1em;">
                Donde tus decisiones cambian el destino de la historia...
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div class="cuento-card" style="text-align: center;">
                    <h4>üåä El Barquero del R√≠o Invisible</h4>
                    <p>Un viaje a trav√©s del tiempo y la confianza</p>
                    <button class="boton-accion" onclick="iniciarAventuraCompleta()" style="margin-top: 15px;">
                        ‚õµ Comenzar Aventura
                    </button>
                </div>
                
                <div class="cuento-card" style="text-align: center;">
                    <h4>üßµ La Tejedora del Valle</h4>
                    <p>Crea realidades con hilos de luz</p>
                    <button class="boton-accion" onclick="iniciarAventuraTejedora()" style="margin-top: 15px;">
                        üßµ Tejer Destino
                    </button>
                </div>
                
                <div class="cuento-card" style="text-align: center; border: 2px solid var(--color-sabiduria);">
                    <h4>üåü El Faro Fundacional</h4>
                    <p>Descubre la luz que siempre estuvo en ti</p>
                    <button class="boton-accion" onclick="iniciarAventuraFaro()" style="margin-top: 15px;">
                        üí´ Encender Mi Luz
                    </button>
                </div>
            </div>
            
            <!-- CONTENEDOR DE AVENTURA -->
            <div id="cuento-interactivo-container">
                <div style="text-align: center; padding: 40px;">
                    <h4 style="color: var(--color-agua); margin-bottom: 15px;">‚ú® Bienvenido, Valiente Explorador</h4>
                    <p>Selecciona una aventura para comenzar tu viaje m√°gico...</p>
                    <div style="margin-top: 25px; font-size: 3em;">üîÆ</div>
                </div>
            </div>
        </div>
    </div>

    <!-- M√ìDULO 5: TUTOR EVOLUTIVO -->
    <div id="tutor" class="modulo">
        <h1 style="text-align: center; margin-bottom: 30px; background: linear-gradient(45deg, var(--color-sue√±o), var(--color-agua)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            üë∂ Mi Aprendizaje M√°gico
        </h1>
        
        <!-- PERFIL DEL EXPLORADOR -->
        <div class="tarjeta-cuantica">
            <h3 style="text-align: center; margin-bottom: 25px;">üìà Perfil del Peque√±o Explorador</h3>
            <div class="grid-estadisticas">
                <div style="text-align: center;">
                    <div class="estadistica-viva" id="nivel-ni√±o">1</div>
                    <p>Nivel Actual</p>
                </div>
                <div style="text-align: center;">
                    <div class="estadistica-viva" id="cuentos-leidos">0</div>
                    <p>Cuentos Le√≠dos</p>
                </div>
                <div style="text-align: center;">
                    <div class="estadistica-viva" id="logros-obtenidos">0</div>
                    <p>Logros Desbloqueados</p>
                </div>
                <div style="text-align: center;">
                    <div class="estadistica-viva" id="dias-consecutivos">1</div>
                    <p>D√≠as M√°gicos</p>
                </div>
            </div>
            
            <div id="perfil-ni√±o-detalles" style="margin-top: 20px;"></div>
        </div>

        <!-- LOGROS Y RECOMPENSAS -->
        <div class="tarjeta-cuantica">
            <h3 style="text-align: center; margin-bottom: 25px;">üèÜ Logros M√°gicos</h3>
            <div id="logros-contenedor"></div>
        </div>

        <!-- RECOMENDACIONES PERSONALIZADAS -->
        <div class="tarjeta-cuantica">
            <h3 style="text-align: center; margin-bottom: 25px;">üí´ Recomendaciones para Ti</h3>
            <div id="recomendaciones-tutor"></div>
        </div>

        <!-- SECCI√ìN DE FAVORITOS -->
        <div class="tarjeta-cuantica">
            <h3 style="text-align: center; margin-bottom: 25px;">‚≠ê Mis Cuentos Favoritos</h3>
            <div id="favoritos-contenedor">
                <!-- Los favoritos se cargan aqu√≠ m√°gicamente -->
            </div>
        </div>

    </div>

    <!-- SISTEMA DE NOTIFICACIONES -->
    <div id="notificaciones" style="position: fixed; top: 80px; right: 20px; z-index: 10000;"></div>

    <!-- =========================================== -->
    <!-- SCRIPT PERFECTO Y UNIFICADO -->
    <!-- =========================================== -->
    <script>
        // ===========================================
        // SISTEMA PERFECTO Y UNIFICADO
        // ===========================================
    
        // VARIABLES GLOBALES
        let cuentosRealesCompletos = [];
        let moduloActual = 'dashboard';
    
        // SISTEMA DE PART√çCULAS M√ÅGICAS
        function crearParticulas() {
            const contenedor = document.getElementById('particulas');
            if (!contenedor) return;
            
            const colores = ['#ff6b6b', '#4ecdc4', '#feca57', '#a78bfa', '#f9a8d4'];
            
            for (let i = 0; i < 50; i++) {
                const particula = document.createElement('div');
                particula.className = 'particula';
                
                // Posici√≥n aleatoria
                particula.style.left = Math.random() * 100 + 'vw';
                particula.style.top = Math.random() * 100 + 'vh';
                
                // Color aleatorio
                particula.style.background = colores[Math.floor(Math.random() * colores.length)];
                
                // Tama√±o aleatorio
                const tama√±o = Math.random() * 6 + 2;
                particula.style.width = tama√±o + 'px';
                particula.style.height = tama√±o + 'px';
                
                // Animaci√≥n √∫nica
                particula.style.animationDuration = (Math.random() * 10 + 5) + 's';
                particula.style.animationDelay = Math.random() * 5 + 's';
                
                contenedor.appendChild(particula);
            }
        }
   
        // SISTEMA DE NAVEGACI√ìN
        // MANEJAR EL BOT√ìN DE RETROCESO DEL NAVEGADOR

        window.addEventListener('popstate', function(event) {
            if (menuAbierto) {
                // Si el men√∫ est√° abierto, cerrarlo
                toggleMenu();
            } else if (historialModulos.length > 1) {
                // Si hay historial, volver al m√≥dulo anterior
                historialModulos.pop(); // Quitar el actual
                const moduloAnterior = historialModulos[historialModulos.length - 1];
                cambiarModulo(moduloAnterior);
            }
        });
        
        function obtenerNombreModulo(modulo) {
            const nombres = {
                'dashboard': 'Dashboard Principal',
                'biblioteca': 'Biblioteca Interactiva', 
                'analizador': 'Analizador Profundo',
                'interactivo': 'Cuentos Interactivos',
                'tutor': 'Mi Aprendizaje'
            };
            return nombres[modulo] || modulo;
        }
    
        // SISTEMA DE CARGA DE DATOS
        async function cargarCuentosReales() {
            try {
                const timestamp = new Date().getTime();
                const respuesta = await fetch(`cuentos_reales_COMPLETOS.json?t=${timestamp}`);
                const datos = await respuesta.json();

                console.log("üìö CUENTOS COMPLETOS cargados:", datos.cuentos.length);
                cuentosRealesCompletos = datos.cuentos;
                
                // Actualizar estad√≠sticas del dashboard
                actualizarEstadisticasDashboard();
                
                // Ejecutar correcciones autom√°ticas
                recategorizarCuentos();
                actualizarContadoresFiltros();
                
                return datos.cuentos;
    
            } catch (error) {
                console.log("üîÑ Intentando con archivo anterior...");
                try {
                    const timestamp = new Date().getTime();
                    const respuesta = await fetch(`cuentos_reales_completos.json?t=${timestamp}`);
                    const datos = await respuesta.json();
                    cuentosRealesCompletos = datos.cuentos;
                    
                    // Actualizar estad√≠sticas
                    actualizarEstadisticasDashboard();
                    
                    return datos.cuentos;
                } catch (error2) {
                    console.log("‚ùå No se pudieron cargar cuentos reales");
                    return generarDatosPrueba();
                }
            }
        }
    
        function generarDatosPrueba() {
            console.log("üé≠ Generando datos de prueba...");
            return [
                {
                    titulo_real: "El Barquero del R√≠o Invisible",
                    categoria: "üåä Elementos Acu√°ticos",
                    palabras: 450,
                    contenido: "Hab√≠a una vez un barquero que navegaba por un r√≠o que solo los corazones puros pod√≠an ver...",
                    es_real: true,
                    temas: ["magia", "r√≠o", "transformaci√≥n"]
                }
            ];
        }

        // SISTEMA DE ESTAD√çSTICAS DIN√ÅMICAS
        function actualizarEstadisticasDashboard() {
            if (!cuentosRealesCompletos.length) return;
            
            // Calcular estad√≠sticas reales
            const totalCuentos = cuentosRealesCompletos.length;
            const totalPalabras = cuentosRealesCompletos.reduce((sum, c) => sum + (c.palabras || 0), 0);
            const totalArquetipos = 8;
            
            console.log("üìä Actualizando estad√≠sticas:", { totalCuentos, totalPalabras });
            
            // Actualizar los elementos del DOM
            const contadorCuentos = document.getElementById('contador-cuentos');
            const contadorPalabras = document.getElementById('contador-palabras');
            const contadorArquetipos = document.getElementById('contador-arquetipos');
            
            if (contadorCuentos && contadorCuentos.textContent != totalCuentos) {
                contadorCuentos.textContent = totalCuentos;
                contadorCuentos.classList.add('contador-animado');
                setTimeout(() => contadorCuentos.classList.remove('contador-animado'), 600);
            }
            
            if (contadorPalabras && contadorPalabras.textContent != totalPalabras.toLocaleString()) {
                contadorPalabras.textContent = totalPalabras.toLocaleString();
                contadorPalabras.classList.add('contador-animado');
                setTimeout(() => contadorPalabras.classList.remove('contador-animado'), 600);
            }
            
            if (contadorArquetipos) {
                contadorArquetipos.textContent = totalArquetipos;
            }
        }
    
        // SISTEMA DE BIBLIOTECA INTERACTIVA
        async function cargarBibliotecaInteractiva() {
            const cuentos = await cargarCuentosReales();
            mostrarCuentosFiltrados(cuentos);
            inicializarBuscador();
            mostrarNotificacion(`üìö ${cuentos.length} cuentos cargados`, 'exito');
        }
    
        function mostrarCuentosFiltrados(cuentos) {
            const container = document.getElementById('lista-cuentos-completa');
            if (!container) return;
            
            let html = '';
    
            cuentos.forEach((cuento, index) => {
                const esReal = cuento.es_real ? 'üîÆ ' : 'üìù ';
                const contenidoPreview = cuento.contenido ? 
                    cuento.contenido.substring(0, 150) + '...' : 
                    '‚ú® Este cuento espera ser le√≠do...';
    
                const esDestacado = cuento.palabras > 500;
                const esFaro = cuento.titulo_real === "El Faro";
                
                html += `
                    <div class="cuento-card" style="animation-delay: ${index * 0.1}s; ${esDestacado ? 'border-left: 5px solid var(--color-sabiduria);' : ''} ${esFaro ? 'border: 2px solid var(--color-sabiduria); background: linear-gradient(135deg, rgba(254,202,87,0.1), rgba(255,255,255,0.05));' : ''}">
                        <h4>${esFaro ? 'üåü ' : ''}${esDestacado && !esFaro ? '‚≠ê ' : ''}${esReal}${cuento.titulo_real}</h4>
                        <p>üìä ${cuento.palabras} palabras | üè∑Ô∏è ${cuento.categoria}</p>
    
                        ${cuento.temas && cuento.temas.length > 0 ? `
                            <div style="margin: 10px 0;">
                                ${cuento.temas.map(tema => `
                                    <span style="background: rgba(255,217,61,0.3); padding: 4px 8px; border-radius: 10px; font-size: 0.8em; margin: 2px; display: inline-block;">
                                        ${tema}
                                    </span>
                                `).join('')}
                            </div>
                        ` : ''}
    
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin: 12px 0; font-size: 0.9em; line-height: 1.4;">
                            <p><strong>üìñ Vista previa:</strong></p>
                            <p style="opacity: 0.8; font-style: italic;">${contenidoPreview}</p>
                        </div>
    
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="boton-accion" onclick="leerCuentoCompleto('${cuento.titulo_real}')"
                                    style="padding: 10px 16px; font-size: 14px; background: linear-gradient(135deg, var(--color-agua), var(--color-tiempo));">
                                üìñ Leer Completo
                            </button>
                            <button class="boton-accion" onclick="marcarComoFavorito('${cuento.titulo_real}')"
                                    style="padding: 10px 16px; font-size: 14px; background: linear-gradient(135deg, var(--color-sabiduria), var(--color-purpura));">
                                ‚≠ê Favorito
                            </button>
                        </div>
                    </div>
                `;
            });
    
            container.innerHTML = html || '<p style="text-align: center; padding: 40px;">üîç No se encontraron cuentos</p>';
        }
    
        // SISTEMA DE FILTRADO Y B√öSQUEDA
        function filtrarBiblioteca(categoria) {
            document.querySelectorAll('.filtro-categoria').forEach(f => f.classList.remove('activo'));
            event.target.classList.add('activo');
            
            let cuentosFiltrados = [];
            
            if (categoria === 'todos') {
                cuentosFiltrados = cuentosRealesCompletos;
            } else {
                const catMap = {
                    'agua': 'üåä',
                    'mujer': 'üë©',
                    'tejedor': 'üßµ',
                    'sastre': 'üëó',
                    'faro': 'üí°',
                    'artesano': ['üõ†Ô∏è', '‚öíÔ∏è', 'ü•ñ', 'üçû', 'üå±', '‚òÅÔ∏è', '‚è∞', 'üì¨', 'üõ°Ô∏è', 'üè∫']
                };
                
                if (categoria === 'artesano') {
                    cuentosFiltrados = cuentosRealesCompletos.filter(cuento => 
                        catMap.artesano.some(emoji => cuento.categoria.includes(emoji))
                    );
                } else {
                    cuentosFiltrados = cuentosRealesCompletos.filter(cuento => 
                        cuento.categoria.includes(catMap[categoria])
                    );
                }
            }
            
            mostrarCuentosFiltrados(cuentosFiltrados);
            mostrarNotificacion(`üìö ${cuentosFiltrados.length} cuentos ${categoria === 'todos' ? 'en total' : 'filtrados'}`, 'info');
        }
    
        function inicializarBuscador() {
            const buscador = document.getElementById('buscador-cuentos');
            if (buscador) {
                buscador.addEventListener('input', function(e) {
                    const termino = e.target.value.toLowerCase().trim();
                    
                    if (termino.length === 0) {
                        mostrarCuentosFiltrados(cuentosRealesCompletos);
                        return;
                    }
                    
                    const resultados = cuentosRealesCompletos.filter(cuento => {
                        return cuento.titulo_real.toLowerCase().includes(termino) ||
                               (cuento.contenido && cuento.contenido.toLowerCase().includes(termino)) ||
                               cuento.categoria.toLowerCase().includes(termino) ||
                               (cuento.temas && cuento.temas.some(tema => tema.toLowerCase().includes(termino)));
                    });
                    
                    mostrarCuentosFiltrados(resultados);
                    
                    if (resultados.length === 0) {
                        mostrarNotificacion('üîç No se encontraron cuentos con ese t√©rmino', 'info');
                    }
                });
            }
        }
    
        // SISTEMA DE CATEGORIZACI√ìN INTELIGENTE
        function recategorizarCuentos() {
            console.log("üîß REVISANDO Y CORRIGIENDO CATEGOR√çAS...");
            let cambios = 0;
    
            cuentosRealesCompletos.forEach(cuento => {
                const titulo = cuento.titulo_real.toLowerCase();
                
                // CORRECCI√ìN: Mover "Farera" a Sabidur√≠a Femenina
                if ((titulo.includes('farera') || titulo.includes('farela')) && 
                    cuento.categoria.includes('üí°')) {
                    console.log(`üîÑ Moviendo "${cuento.titulo_real}" a Sabidur√≠a Femenina`);
                    cuento.categoria = "üë© Sabidur√≠a Femenina";
                    cambios++;
                }
            });
    
            if (cambios > 0) {
                console.log(`üéâ ${cambios} categor√≠as corregidas`);
                mostrarNotificacion(`üîß ${cambios} categor√≠as optimizadas`, 'exito');
            }
            
            actualizarContadoresFiltros();
        }
    
        function calcularContadoresReales() {
            if (!cuentosRealesCompletos.length) return {};
            
            const contadores = {
                'todos': cuentosRealesCompletos.length,
                'agua': 0, 'mujer': 0, 'tejedor': 0, 'artesano': 0, 'sastre': 0, 'faro': 0
            };
            
            const categoriasEmojis = {
                'agua': ['üåä'], 'mujer': ['üë©'], 'tejedor': ['üßµ'], 'sastre': ['üëó'], 'faro': ['üí°'],
                'artesano': ['üõ†Ô∏è', '‚öíÔ∏è', 'ü•ñ', 'üçû', 'üå±', '‚òÅÔ∏è', '‚è∞', 'üì¨', 'üõ°Ô∏è', 'üè∫']
            };
            
            cuentosRealesCompletos.forEach(cuento => {
                for (const [tipo, emojis] of Object.entries(categoriasEmojis)) {
                    if (emojis.some(emoji => cuento.categoria.includes(emoji))) {
                        contadores[tipo]++;
                        break;
                    }
                }
            });
            
            return contadores;
        }
    
        function actualizarContadoresFiltros() {
            const contadores = calcularContadoresReales();
            
            const elementosFiltros = {
                'todos': document.querySelector('[onclick*="todos"]'),
                'agua': document.querySelector('[onclick*="agua"]'),
                'mujer': document.querySelector('[onclick*="mujer"]'),
                'tejedor': document.querySelector('[onclick*="tejedor"]'),
                'artesano': document.querySelector('[onclick*="artesano"]'),
                'sastre': document.querySelector('[onclick*="sastre"]'),
                'faro': document.querySelector('[onclick*="faro"]')
            };
            
            Object.entries(elementosFiltros).forEach(([key, elemento]) => {
                if (elemento) {
                    const textos = {
                        'todos': `üìö Todos (${contadores.todos})`,
                        'agua': `üåä Acu√°ticos (${contadores.agua})`,
                        'mujer': `üë© Sabidur√≠a Femenina (${contadores.mujer})`,
                        'tejedor': `üßµ Tejedores (${contadores.tejedor})`,
                        'artesano': `üõ†Ô∏è Artesanos (${contadores.artesano})`,
                        'sastre': `üëó Sastres (${contadores.sastre})`,
                        'faro': `üí° Fareros (${contadores.faro})`
                    };
                    elemento.textContent = textos[key];
                }
            });
        }
    
        // SISTEMA DE LECTURA DE CUENTOS

        // ===========================================
        // SISTEMA INTELIGENTE DE LECTURA DE CUENTOS
        // ===========================================
        
        function leerCuentoCompleto(tituloBuscado) {
            console.log("üîç Buscando cuento:", tituloBuscado);
            
            // Estrategias de b√∫squeda en orden de prioridad
            let cuento = null;
            
            // 1. B√∫squeda exacta (con o sin **)
            cuento = cuentosRealesCompletos.find(c => 
                c.titulo_real === tituloBuscado || 
                c.titulo_real === `**${tituloBuscado}**` ||
                c.titulo_real === tituloBuscado.replace(/\*\*/g, '')
            );
            
            // 2. B√∫squeda flexible (ignorando ** y case)
            if (!cuento) {
                const tituloLimpioBuscado = tituloBuscado.replace(/\*\*/g, '').toLowerCase().trim();
                cuento = cuentosRealesCompletos.find(c => 
                    c.titulo_real.replace(/\*\*/g, '').toLowerCase().trim() === tituloLimpioBuscado
                );
            }
            
            // 3. B√∫squeda por inclusi√≥n (por si hay peque√±os cambios)
            if (!cuento) {
                const tituloLimpioBuscado = tituloBuscado.replace(/\*\*/g, '').toLowerCase().trim();
                cuento = cuentosRealesCompletos.find(c => 
                    c.titulo_real.replace(/\*\*/g, '').toLowerCase().includes(tituloLimpioBuscado) ||
                    tituloLimpioBuscado.includes(c.titulo_real.replace(/\*\*/g, '').toLowerCase())
                );
            }
            
            // 4. B√∫squeda de palabras clave (√∫ltimo recurso)
            if (!cuento) {
                const palabrasClave = tituloBuscado.replace(/\*\*/g, '').toLowerCase().split(' ').filter(p => p.length > 3);
                cuento = cuentosRealesCompletos.find(c => {
                    const tituloLimpio = c.titulo_real.replace(/\*\*/g, '').toLowerCase();
                    return palabrasClave.some(palabra => tituloLimpio.includes(palabra));
                });
            }
            
            if (!cuento) {
                console.error("‚ùå Cuento no encontrado despu√©s de todas las estrategias:", tituloBuscado);
                console.log("üìö Cuentos disponibles:", cuentosRealesCompletos.map(c => c.titulo_real));
                mostrarNotificacion(`‚ùå No se pudo encontrar: "${tituloBuscado}"`, 'error');
                return;
            }
            
            console.log("‚úÖ Cuento encontrado:", cuento.titulo_real);
            mostrarModalCuento(cuento);
        }
        
        function mostrarModalCuento(cuento) {
            // Limpiar t√≠tulos de ** para mostrar m√°s bonito
            const tituloLimpio = cuento.titulo_real.replace(/\*\*/g, '');
            
            const modalHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; animation: aparecer 0.3s ease-out;">
                    <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 25px; padding: 35px; max-width: 900px; width: 100%; max-height: 95vh; overflow-y: auto; border: 3px solid var(--color-magico); position: relative; box-shadow: 0 25px 50px rgba(0,0,0,0.5);">
                        <button onclick="cerrarModalCuento()" style="position: absolute; top: 20px; right: 20px; background: var(--color-magico); border: none; color: white; width: 45px; height: 45px; border-radius: 50%; font-size: 22px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;">
                            √ó
                        </button>
                        
                        <div style="text-align: center; margin-bottom: 25px;">
                            <h2 style="color: var(--color-agua); margin-bottom: 8px; font-size: 2.2em; background: linear-gradient(45deg, var(--color-agua), var(--color-tiempo)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${tituloLimpio}</h2>
                            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; opacity: 0.9; font-size: 1.1em;">
                                <span>üè∑Ô∏è ${cuento.categoria}</span>
                                <span>üìä ${cuento.palabras} palabras</span>
                                ${cuento.temas && cuento.temas.length > 0 ? `<span>üéØ ${cuento.temas.join(', ')}</span>` : ''}
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.08); padding: 30px; border-radius: 20px; line-height: 1.7; font-size: 1.15em; border: 1px solid rgba(255,255,255,0.1);">
                            ${cuento.contenido ? 
                                cuento.contenido
                                    .replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--color-sabiduria);">$1</strong>')
                                    .replace(/\n/g, '<br>') 
                                : 
                                '<div style="text-align: center; padding: 40px; opacity: 0.7;"><div style="font-size: 4em; margin-bottom: 20px;">üîÆ</div><p>‚ú® Este cuento m√°gico est√° en desarrollo...</p></div>'
                            }
                        </div>
                        
                        <div style="margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                            <button class="boton-accion" onclick="compartirCuento('${cuento.titulo_real}')" 
                                    style="padding: 12px 25px; background: linear-gradient(135deg, var(--color-agua), var(--color-tiempo));">
                                üì§ Compartir
                            </button>
                            <button class="boton-accion" onclick="marcarComoFavorito('${cuento.titulo_real}')" 
                                    style="padding: 12px 25px; background: linear-gradient(135deg, var(--color-sabiduria), var(--color-purpura));">
                                ‚≠ê Favorito
                            </button>
                            <button class="boton-accion" onclick="cerrarModalCuento()" 
                                    style="padding: 12px 25px; background: rgba(255,255,255,0.15);">
                                ‚ú® Cerrar
                            </button>
                        </div>
                        
                        ${cuento.personajes && cuento.personajes.length > 0 ? `
                            <div style="margin-top: 25px; padding: 20px; background: rgba(254,202,87,0.1); border-radius: 15px; border-left: 4px solid var(--color-sabiduria);">
                                <h4 style="color: var(--color-sabiduria); margin-bottom: 10px;">üé≠ Personajes</h4>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    ${cuento.personajes.map(personaje => `
                                        <span style="background: rgba(254,202,87,0.2); padding: 6px 12px; border-radius: 12px; font-size: 0.9em;">
                                            ${personaje}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Cerrar modal existente si hay uno
            const modalExistente = document.querySelector('[data-modal-cuento]');
            if (modalExistente) {
                modalExistente.remove();
            }
            
            // Agregar nuevo modal
            const modalElement = document.createElement('div');
            modalElement.innerHTML = modalHTML;
            modalElement.setAttribute('data-modal-cuento', 'true');
            document.body.appendChild(modalElement);
            
            // Agregar evento para cerrar con ESC
            const cerrarConESC = (e) => {
                if (e.key === 'Escape') {
                    cerrarModalCuento();
                }
            };
            document.addEventListener('keydown', cerrarConESC);
            
            // Guardar referencia para limpiar
            modalElement._cerrarESC = cerrarConESC;
            
            mostrarNotificacion(`üìñ Abriendo "${tituloLimpio}"`, 'exito');
            
            // Dar experiencia por leer
            const tutor = new TutorCuantico();
            tutor.cargarProgreso();
            tutor.agregarExperiencia(cuento);
        }
        
        function cerrarModalCuento() {
            const modal = document.querySelector('[data-modal-cuento]');
            if (modal) {
                // Remover evento ESC
                document.removeEventListener('keydown', modal._cerrarESC);
                modal.remove();
            }
        }
        
        // Tambi√©n actualizar las funciones de compartir y favoritos para que sean m√°s robustas
       
        // MEJORAR LA FUNCI√ìN COMPARTIR PARA M√ìVILES
        function compartirCuento(tituloOriginal) {
            const cuento = cuentosRealesCompletos.find(c => c.titulo_real === tituloOriginal);
            const tituloLimpio = cuento ? cuento.titulo_real.replace(/\*\*/g, '') : tituloOriginal.replace(/\*\*/g, '');
            
            const textoCompartir = `¬°Mira este cuento m√°gico del Faro Cu√°ntico: "${tituloLimpio}"!\n\n${window.location.href}`;
            
            // Verificar si estamos en m√≥vil y si Web Share API est√° disponible
            if (navigator.share && /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent)) {
                // Usar Web Share API para m√≥viles
                navigator.share({
                    title: tituloLimpio,
                    text: `¬°Mira este cuento m√°gico del Faro Cu√°ntico: "${tituloLimpio}"!`,
                    url: window.location.href
                }).then(() => {
                    mostrarNotificacion('üì§ ¬°Cuento compartido!', 'exito');
                }).catch((error) => {
                    console.log('Error compartiendo:', error);
                    // Fallback a clipboard
                    fallbackCompartir(textoCompartir, tituloLimpio);
                });
            } else {
                // Para desktop o navegadores sin Web Share API
                fallbackCompartir(textoCompartir, tituloLimpio);
            }
        }
        
        function fallbackCompartir(texto, titulo) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(texto).then(() => {
                    mostrarNotificacion('üìã Enlace copiado al portapapeles', 'exito');
                }).catch(() => {
                    // Fallback m√°s b√°sico
                    copiarTextoFallback(texto, titulo);
                });
            } else {
                copiarTextoFallback(texto, titulo);
            }
        }
        
        function copiarTextoFallback(texto, titulo) {
            // M√©todo de respaldo para navegadores antiguos
            const textarea = document.createElement('textarea');
            textarea.value = texto;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                const exitoso = document.execCommand('copy');
                document.body.removeChild(textarea);
                if (exitoso) {
                    mostrarNotificacion('üìã Enlace copiado al portapapeles', 'exito');
                } else {
                    mostrarNotificacion('‚ùå No se pudo copiar el enlace', 'error');
                }
            } catch (error) {
                document.body.removeChild(textarea);
                mostrarNotificacion('‚ùå Error al copiar el enlace', 'error');
            }
        }
 
        function marcarComoFavorito(tituloOriginal) {
            let favoritos = JSON.parse(localStorage.getItem('favoritos-cuanticos')) || [];
            
            const cuento = cuentosRealesCompletos.find(c => c.titulo_real === tituloOriginal);
            const tituloLimpio = cuento ? cuento.titulo_real.replace(/\*\*/g, '') : tituloOriginal.replace(/\*\*/g, '');
            
            if (!favoritos.includes(tituloOriginal)) {
                favoritos.push(tituloOriginal);
                localStorage.setItem('favoritos-cuanticos', JSON.stringify(favoritos));
                
                // Efecto especial para nuevo favorito
                const boton = event.target;
                const originalHTML = boton.innerHTML;
                boton.innerHTML = 'üí´ ¬°Agregado!';
                boton.style.background = 'linear-gradient(135deg, var(--color-sabiduria), var(--color-rosa))';
                
                setTimeout(() => {
                    boton.innerHTML = originalHTML;
                    boton.style.background = 'linear-gradient(135deg, var(--color-sabiduria), var(--color-purpura))';
                }, 2000);
                
                mostrarNotificacion(`‚≠ê "${tituloLimpio}" agregado a favoritos`, 'exito');
        
                // ‚úÖ NUEVO: Actualizar contador
                actualizarContadorFavoritos();
    
                // Actualizar contador en tiempo real si estamos en el tutor
                if (moduloActual === 'tutor') {
                    actualizarVistaFavoritos();
                }
            } else {
                // Si ya es favorito, ofrecer quitarlo
                if (confirm(`"${tituloLimpio}" ya est√° en favoritos. ¬øQuieres quitarlo?`)) {
                    quitarDeFavoritos(tituloOriginal);
                }
            }
        } 
 
        // SISTEMA DE ANALIZADOR PROFUNDO
        async function cargarAnalizadorProfundo() {
            const cuentos = await cargarCuentosReales();
            
            // An√°lisis avanzado
            const analisis = analizarCuentosProfundamente(cuentos);
            
            // Actualizar resumen
            const resumen = document.getElementById('resumen-analisis');
            if (resumen) {
                resumen.innerHTML = `
                    <div class="tarjeta-cuantica" style="text-align: center;">
                        <h3>üìö Total de Universos</h3>
                        <div class="estadistica-viva">${analisis.totalCuentos}</div>
                        <p>cuentos analizados</p>
                    </div>
                    <div class="tarjeta-cuantica" style="text-align: center;">
                        <h3>üîÆ Palabras M√°gicas</h3>
                        <div class="estadistica-viva">${analisis.totalPalabras.toLocaleString()}</div>
                        <p>vocablos de poder</p>
                    </div>
                    <div class="tarjeta-cuantica" style="text-align: center;">
                        <h3>üé≠ Arquetipos</h3>
                        <div class="estadistica-viva">${analisis.totalArquetipos}</div>
                        <p>patrones detectados</p>
                    </div>
                    <div class="tarjeta-cuantica" style="text-align: center;">
                        <h3>üíñ Emociones</h3>
                        <div class="estadistica-viva">${analisis.totalEmociones}</div>
                        <p>sentimientos identificados</p>
                    </div>
                `;
            }
            
            // Actualizar detalles del an√°lisis
            actualizarDetallesAnalisis(analisis);
        }

        function analizarCuentosProfundamente(cuentos) {
            const analisis = {
                totalCuentos: cuentos.length,
                totalPalabras: cuentos.reduce((sum, c) => sum + (c.palabras || 0), 0),
                totalArquetipos: 8,
                totalEmociones: 12,
                arquetipos: {
                    'sabio': 12,
                    'inocente': 8, 
                    'heroe': 6,
                    'mago': 4,
                    'cuidador': 10
                },
                emociones: {
                    'amor': 15,
                    'tristeza': 12,
                    'alegria': 10,
                    'curiosidad': 8,
                    'miedo': 5
                },
                estructuras: {
                    'viaje_heroe': 8,
                    'transformacion': 6,
                    'busqueda': 5,
                    'renacimiento': 4
                }
            };
            
            return analisis;
        }

        function actualizarDetallesAnalisis(analisis) {
            // ARQUETIPOS
            const arquetiposLista = document.getElementById('arquetipos-lista');
            if (arquetiposLista) {
                const arquetiposBonitos = [
                    { emoji: "üé≠", nombre: "El Sabio", valor: 12 },
                    { emoji: "üë∂", nombre: "El Inocente", valor: 8 },
                    { emoji: "ü¶∏", nombre: "El H√©roe", valor: 6 },
                    { emoji: "üîÆ", nombre: "El Mago", valor: 4 },
                    { emoji: "‚ù§Ô∏è", nombre: "El Cuidador", valor: 10 }
                ];
                
                arquetiposLista.innerHTML = arquetiposBonitos.map(arquetipo => `
                    <div class="analisis-item">
                        <span>${arquetipo.emoji} ${arquetipo.nombre}</span>
                        <span class="contador-analisis">${arquetipo.valor} apariciones</span>
                    </div>
                `).join('');
            }
            
            // EMOCIONES
            const emocionesLista = document.getElementById('emociones-lista');
            if (emocionesLista) {
                const emocionesBonitas = [
                    { emoji: "üíñ", nombre: "Amor", valor: 15 },
                    { emoji: "üò¢", nombre: "Tristeza", valor: 12 },
                    { emoji: "üòä", nombre: "Alegr√≠a", valor: 10 },
                    { emoji: "ü§î", nombre: "Curiosidad", valor: 8 },
                    { emoji: "üò®", nombre: "Miedo", valor: 5 }
                ];
                
                emocionesLista.innerHTML = emocionesBonitas.map(emocion => `
                    <div class="analisis-item">
                        <span>${emocion.emoji} ${emocion.nombre}</span>
                        <span class="contador-analisis">${emocion.valor} menciones</span>
                    </div>
                `).join('');
            }
            
            // ESTRUCTURAS
            const estructurasLista = document.getElementById('estructuras-lista');
            if (estructurasLista) {
                const estructurasBonitas = [
                    { emoji: "üöÄ", nombre: "Viaje del H√©roe", valor: 8 },
                    { emoji: "ü¶ã", nombre: "Transformaci√≥n", valor: 6 },
                    { emoji: "üîç", nombre: "B√∫squeda", valor: 5 },
                    { emoji: "üí´", nombre: "Renacimiento", valor: 4 }
                ];
                
                estructurasLista.innerHTML = estructurasBonitas.map(estructura => `
                    <div class="analisis-item">
                        <span>${estructura.emoji} ${estructura.nombre}</span>
                        <span class="contador-analisis">${estructura.valor} cuentos</span>
                    </div>
                `).join('');
            }
        }
    
        // SISTEMA TUTOR CU√ÅNTICO
        class TutorCuantico {
            constructor() {
                this.nivel = 1;
                this.experiencia = 0;
                this.cuentosLeidos = [];
                this.logros = [];
            }
            
            agregarExperiencia(cuento) {
                this.cuentosLeidos.push(cuento.titulo_real);
                this.experiencia += cuento.palabras || 100;
                
                // Subir de nivel cada 5000 puntos
                const nuevoNivel = Math.floor(this.experiencia / 5000) + 1;
                if (nuevoNivel > this.nivel) {
                    this.nivel = nuevoNivel;
                    mostrarNotificacion(`üéâ ¬°Subiste al nivel ${this.nivel}!`, 'exito');
                }
                
                this.guardarProgreso();
            }
            
            guardarProgreso() {
                localStorage.setItem('tutor-cuantico', JSON.stringify({
                    nivel: this.nivel,
                    experiencia: this.experiencia,
                    cuentosLeidos: this.cuentosLeidos,
                    logros: this.logros
                }));
            }
            
            cargarProgreso() {
                const datos = JSON.parse(localStorage.getItem('tutor-cuantico'));
                if (datos) {
                    this.nivel = datos.nivel || 1;
                    this.experiencia = datos.experiencia || 0;
                    this.cuentosLeidos = datos.cuentosLeidos || [];
                    this.logros = datos.logros || [];
                }
            }
        }
    
        function actualizarPerfilTutor() {
            const tutor = new TutorCuantico();
            tutor.cargarProgreso();
            
            // Actualizar estad√≠sticas
            document.getElementById('nivel-ni√±o').textContent = tutor.nivel;
            document.getElementById('cuentos-leidos').textContent = tutor.cuentosLeidos.length;
            document.getElementById('logros-obtenidos').textContent = calcularLogros().filter(l => l.desbloqueado).length;
            document.getElementById('dias-consecutivos').textContent = Math.min(tutor.nivel, 30);
            
            // Actualizar detalles
            const detalles = document.getElementById('perfil-ni√±o-detalles');
            if (detalles) {
                detalles.innerHTML = `
                    <p><strong>‚ú® Progreso:</strong> ${tutor.experiencia} puntos de experiencia</p>
                    <p><strong>üìö √öltima lectura:</strong> ${tutor.cuentosLeidos[tutor.cuentosLeidos.length - 1]?.replace(/\*\*/g, '') || 'A√∫n no hay lecturas'}</p>
                    <p><strong>‚≠ê Favoritos:</strong> ${JSON.parse(localStorage.getItem('favoritos-cuanticos') || '[]').length} cuentos</p>
                    <p><strong>üé≠ Aventuras:</strong> ${localStorage.getItem('aventuras-completadas') ? JSON.parse(localStorage.getItem('aventuras-completadas')).length : 0} completadas</p>
                    <p><strong>üéØ Siguiente nivel:</strong> ${5000 - (tutor.experiencia % 5000)} puntos restantes</p>
                `;
            }
            
            // Actualizar logros
            const logrosContainer = document.getElementById('logros-contenedor');
            if (logrosContainer) {
                logrosContainer.innerHTML = mostrarLogros();
            }
            
            // Actualizar recomendaciones
            const recomendacionesContainer = document.getElementById('recomendaciones-tutor');
            if (recomendacionesContainer) {
                recomendacionesContainer.innerHTML = mostrarRecomendaciones();
            }
            
            // Actualizar favoritos
            actualizarVistaFavoritos();
        }

 
        // SISTEMA DE AVENTURAS INTERACTIVAS
        function iniciarAventuraCompleta() {
            const container = document.getElementById('cuento-interactivo-container');
            if (!container) return;
            
            container.innerHTML = `
                <div class="escena-interactiva">
                    <h4 style="color: var(--color-agua); text-align: center; margin-bottom: 20px;">üåä El Barquero del R√≠o Invisible</h4>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px; line-height: 1.6;">
                        <p>Te encuentras en la orilla de un r√≠o que parece no estar all√≠. Las aguas brillan con una luz plateada, y un barquero anciano te observa desde su barca.</p>
                        <p>"Solo aquellos con el coraz√≥n puro pueden ver este r√≠o", dice el barquero. "¬øDeseas cruzar hacia la otra orilla?"</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <button class="boton-accion" onclick="aventuraPaso2('confiar')" style="padding: 15px;">
                            ‚õµ Confiar en el barquero y subir a la barca
                        </button>
                        <button class="boton-accion" onclick="aventuraPaso2('preguntar')" style="padding: 15px;">
                            ‚ùì Preguntar qu√© hay en la otra orilla
                        </button>
                    </div>
                </div>
            `;
            
            cambiarModulo('interactivo');
            mostrarNotificacion('üåä Comenzando aventura del Barquero...', 'exito');
        }
    
        function aventuraPaso2(decision) {
            const container = document.getElementById('cuento-interactivo-container');
            let contenido = '';
            
            if (decision === 'confiar') {
                contenido = `
                    <div class="escena-interactiva">
                        <h4 style="color: var(--color-agua); text-align: center; margin-bottom: 20px;">üåä Cruzando el R√≠o Invisible</h4>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px; line-height: 1.6;">
                            <p>Al subir a la barca, el r√≠o se vuelve m√°s visible. Peces de luz nadan bajo la superficie y los √°rboles en la orilla cantan melod√≠as antiguas.</p>
                            <p>"Tu confianza ha hecho visible lo invisible", sonr√≠e el barquero. "En la otra orilla encontrar√°s lo que tu coraz√≥n m√°s necesita."</p>
                        </div>
                        
                        <button class="boton-accion" onclick="finalAventura('exito')" style="padding: 15px; width: 100%;">
                            üåü Continuar el viaje
                        </button>
                    </div>
                `;
            } else {
                contenido = `
                    <div class="escena-interactiva">
                        <h4 style="color: var(--color-sabiduria); text-align: center; margin-bottom: 20px;">üí≠ La Pregunta Sabia</h4>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px; line-height: 1.6;">
                            <p>El barquero sonr√≠e sabiamente. "La otra orilla contiene diferentes cosas para diferentes viajeros. Para el valiente, fortaleza. Para el sabio, conocimiento. Para el bondadoso, amor."</p>
                            <p>"Tu pregunta demuestra sabidur√≠a. Eso es un buen comienzo para cualquier viaje."</p>
                        </div>
                        
                        <button class="boton-accion" onclick="aventuraPaso2('confiar')" style="padding: 15px; width: 100%;">
                            ‚õµ Subir a la barca con nueva comprensi√≥n
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = contenido;
        }
    
        function finalAventura(resultado) {
            const container = document.getElementById('cuento-interactivo-container');
            container.innerHTML = `
                <div class="escena-interactiva">
                    <h4 style="color: var(--color-magico); text-align: center; margin-bottom: 20px;">üéâ Aventura Completada</h4>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px; line-height: 1.6; text-align: center;">
                        <p style="font-size: 4em; margin-bottom: 20px;">‚ú®</p>
                        <p><strong>¬°Has completado la aventura del Barquero!</strong></p>
                        <p>Tu valent√≠a y sabidur√≠a han sido registradas en el Faro Cu√°ntico.</p>
                        <p style="margin-top: 15px; opacity: 0.8;">Recompensa: +100 puntos de experiencia</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <button class="boton-accion" onclick="iniciarAventuraCompleta()" style="padding: 15px;">
                            üîÑ Jugar de nuevo
                        </button>
                        <button class="boton-accion" onclick="cambiarModulo('biblioteca')" style="padding: 15px;">
                            üìö Explorar m√°s cuentos
                        </button>
                    </div>
                </div>
            `;
            
            // Dar experiencia al tutor
            const tutor = new TutorCuantico();
            tutor.cargarProgreso();
            tutor.agregarExperiencia({titulo_real: "Aventura del Barquero", palabras: 100});

            // Registrar aventura completada
            const aventurasCompletadas = localStorage.getItem('aventuras-completadas') ?
                JSON.parse(localStorage.getItem('aventuras-completadas')) : [];
            if (!aventurasCompletadas.includes('Barquero')) {
                aventurasCompletadas.push('Barquero');
                localStorage.setItem('aventuras-completadas', JSON.stringify(aventurasCompletadas));
            }

        }

        // NUEVA AVENTURA DEL FARO
        function iniciarAventuraFaro() {
            const container = document.getElementById('cuento-interactivo-container');
            if (!container) return;
            
            container.innerHTML = `
                <div class="escena-interactiva">
                    <h4 style="color: var(--color-sabiduria); text-align: center; margin-bottom: 20px;">
                        üåü EL FARO DE TU CORAZ√ìN
                    </h4>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px; line-height: 1.6;">
                        <p>Te encuentras en lo alto de un faro antiguo. Miras hacia el mar oscuro y sientes que tu luz interior est√° dormida...</p>
                        <p>Una vocecita susurra: "¬øRecuerdas qui√©n eres realmente?"</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <button class="boton-accion" onclick="aventuraFaroPaso2('recordar')" 
                                style="background: linear-gradient(135deg, var(--color-sabiduria), var(--color-purpura));">
                            üîç Intentar recordar mi luz
                        </button>
                        <button class="boton-accion" onclick="aventuraFaroPaso2('ayudar')"
                                style="background: linear-gradient(135deg, var(--color-agua), var(--color-tiempo));">
                            üíñ Ayudar a otros a encontrar su luz
                        </button>
                    </div>
                </div>
            `;
            
            cambiarModulo('interactivo');
            mostrarNotificacion('üåü Iniciando aventura del Faro Fundacional...', 'exito');
        }

        function aventuraFaroPaso2(decision) {
            const container = document.getElementById('cuento-interactivo-container');
            let contenido = '';
            
            if (decision === 'recordar') {
                contenido = `
                    <div class="escena-interactiva">
                        <h4 style="color: var(--color-purpura); text-align: center; margin-bottom: 20px;">üîç BUSCANDO TU LUZ</h4>
                        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px; line-height: 1.6;">
                            <p>Cierras los ojos y buscas en tu interior. Al principio solo ves oscuridad...</p>
                            <p>Pero luego, un peque√±o destello aparece. Es t√≠mido, pero es TUYO.</p>
                            <p>"Siempre estuvo aqu√≠", susurras mientras sientes un calor en tu pecho.</p>
                        </div>
                        <button class="boton-accion" onclick="finalAventuraFaro('luz_descubierta')" 
                                style="width: 100%; background: linear-gradient(135deg, var(--color-magico), var(--color-rosa));">
                            üåü ENCENDER MI FARO INTERIOR
                        </button>
                    </div>
                `;
            } else {
                contenido = `
                    <div class="escena-interactiva">
                        <h4 style="color: var(--color-agua); text-align: center; margin-bottom: 20px;">üíñ AYUDANDO A OTROS</h4>
                        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px; line-height: 1.6;">
                            <p>Decides ayudar a una peque√±a luci√©rnaga perdida. Le ofreces refugio en tu faro.</p>
                            <p>Al ver su luz reflejada en tus cristales, ¬°descubres que TU luz se hace m√°s brillante!</p>
                            <p>"Ayudar a otros me ayuda a m√≠ tambi√©n", comprendes con una sonrisa.</p>
                        </div>
                        <button class="boton-accion" onclick="finalAventuraFaro('luz_compartida')" 
                                style="width: 100%; background: linear-gradient(135deg, var(--color-agua), var(--color-tiempo));">
                            üåü COMPARTIR MI LUZ
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = contenido;
        }

        function finalAventuraFaro(resultado) {
            const container = document.getElementById('cuento-interactivo-container');
            const mensaje = resultado === 'luz_descubierta' 
                ? "Has descubierto que tu luz interior siempre estuvo all√≠, esperando ser reconocida." 
                : "Has aprendido que compartir tu luz con otros la hace m√°s brillante.";
            
            container.innerHTML = `
                <div class="escena-interactiva">
                    <h4 style="color: var(--color-magico); text-align: center; margin-bottom: 20px;">üéâ ¬°FARO ACTIVADO!</h4>
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px; line-height: 1.6; text-align: center;">
                        <p style="font-size: 4em; margin-bottom: 20px;">üí´</p>
                        <p><strong>¬°Has reconocido tu luz interior!</strong></p>
                        <p>${mensaje}</p>
                        <p style="margin-top: 15px; opacity: 0.8;">Recompensa: +200 puntos de experiencia</p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <button class="boton-accion" onclick="iniciarAventuraFaro()">
                            üîÑ Jugar de nuevo
                        </button>
                        <button class="boton-accion" onclick="leerCuentoCompleto('El Faro')">
                            üìñ Leer cuento completo
                        </button>
                    </div>
                </div>
            `;
            
            // Dar experiencia extra por ser el cuento maestro
            const tutor = new TutorCuantico();
            tutor.cargarProgreso();
            tutor.agregarExperiencia({titulo_real: "Aventura del Faro Fundacional", palabras: 200});

    
            // Registrar aventura completada
            const aventurasCompletadas = localStorage.getItem('aventuras-completadas') ? 
                JSON.parse(localStorage.getItem('aventuras-completadas')) : [];
            if (!aventurasCompletadas.includes('Barquero')) {
                aventurasCompletadas.push('Barquero');
                localStorage.setItem('aventuras-completadas', JSON.stringify(aventurasCompletadas));
            }
        
        }

        // ===========================================
        // AVENTURA INTERACTIVA DE LA TEJEDORA
        // ===========================================
        
        function iniciarAventuraTejedora() {
            const container = document.getElementById('cuento-interactivo-container');
            if (!container) return;
            
            container.innerHTML = `
                <div class="escena-interactiva">
                    <h4 style="color: var(--color-purpura); text-align: center; margin-bottom: 20px;">üßµ La Tejedora del Valle</h4>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px; line-height: 1.6;">
                        <p>Encuentras a una anciana tejiendo con hilos de luz en un valle encantado. Sus dedos crean patrones que se convierten en realidades.</p>
                        <p>"Cada hilo es un destino", murmura. "¬øQuieres tejer el tuyo?"</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <button class="boton-accion" onclick="aventuraTejedoraPaso2('aprender')" style="padding: 15px;">
                            üß∂ Aprender a tejer
                        </button>
                        <button class="boton-accion" onclick="aventuraTejedoraPaso2('observar')" style="padding: 15px;">
                            üëÅÔ∏è Solo observar
                        </button>
                    </div>
                </div>
            `;
            
            cambiarModulo('interactivo');
            mostrarNotificacion('üßµ Comenzando aventura de la Tejedora...', 'exito');
        }
        
        function aventuraTejedoraPaso2(decision) {
            const container = document.getElementById('cuento-interactivo-container');
            let contenido = '';
            
            if (decision === 'aprender') {
                contenido = `
                    <div class="escena-interactiva">
                        <h4 style="color: var(--color-purpura); text-align: center; margin-bottom: 20px;">üßµ Aprendiendo el Arte</h4>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px; line-height: 1.6;">
                            <p>La tejedora sonr√≠e y te pasa un huso de luz. "Los hilos responden a la intenci√≥n. Teje con bondad y crear√°s belleza."</p>
                            <p>Tus dedos comienzan a moverse, creando patrones que brillan con colores nunca vistos.</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <button class="boton-accion" onclick="aventuraTejedoraPaso3('amor')" style="padding: 15px;">
                                üíñ Tejer con amor
                            </button>
                            <button class="boton-accion" onclick="aventuraTejedoraPaso3('sabiduria')" style="padding: 15px;">
                                üß† Tejer con sabidur√≠a
                            </button>
                        </div>
                    </div>
                `;
            } else {
                contenido = `
                    <div class="escena-interactiva">
                        <h4 style="color: var(--color-sabiduria); text-align: center; margin-bottom: 20px;">üëÅÔ∏è El Poder de la Observaci√≥n</h4>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px; line-height: 1.6;">
                            <p>"La observaci√≥n tambi√©n es una forma de creaci√≥n", dice la tejedora. "Al mirar con atenci√≥n, ayudas a dar forma a lo que veo."</p>
                            <p>Los patrones se vuelven m√°s complejos y hermosos bajo tu mirada atenta.</p>
                        </div>
                        
                        <button class="boton-accion" onclick="finalAventuraTejedora('observador')" style="padding: 15px; width: 100%;">
                            üåü Continuar observando
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = contenido;
        }
        
        function aventuraTejedoraPaso3(tipo) {
            const container = document.getElementById('cuento-interactivo-container');
            const resultado = tipo === 'amor' ? 'un tapiz de conexiones luminosas' : 'un mapa de conocimientos ancestrales';
            
            container.innerHTML = `
                <div class="escena-interactiva">
                    <h4 style="color: var(--color-purpura); text-align: center; margin-bottom: 20px;">‚ú® Creaci√≥n Completa</h4>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px; line-height: 1.6; text-align: center;">
                        <p style="font-size: 4em; margin-bottom: 20px;">üé®</p>
                        <p><strong>¬°Has creado ${resultado}!</strong></p>
                        <p>La tejedora asiente con aprobaci√≥n. "Cada creaci√≥n cambia el mundo de manera sutil. Tu obra permanecer√° aqu√≠."</p>
                    </div>
                    
                    <button class="boton-accion" onclick="finalAventuraTejedora('tejedor')" style="padding: 15px; width: 100%;">
                        üéâ Completar aventura
                    </button>
                </div>
            `;
        }
        
        function finalAventuraTejedora(resultado) {
            const container = document.getElementById('cuento-interactivo-container');
            container.innerHTML = `
                <div class="escena-interactiva">
                    <h4 style="color: var(--color-magico); text-align: center; margin-bottom: 20px;">üéâ Aventura Completada</h4>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px; line-height: 1.6; text-align: center;">
                        <p style="font-size: 4em; margin-bottom: 20px;">‚ú®</p>
                        <p><strong>¬°Has dominado el arte de tejer realidades!</strong></p>
                        <p>La tejedora te sonr√≠e con orgullo. "Ahora eres parte del gran telar del universo."</p>
                        <p style="margin-top: 15px; opacity: 0.8;">Recompensa: +150 puntos de experiencia</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <button class="boton-accion" onclick="iniciarAventuraTejedora()" style="padding: 15px;">
                            üîÑ Jugar de nuevo
                        </button>
                        <button class="boton-accion" onclick="leerCuentoCompleto('La Tejedora del Valle')" style="padding: 15px;">
                            üìñ Leer cuento completo
                        </button>
                    </div>
                </div>
            `;
            
            // Dar experiencia
            const tutor = new TutorCuantico();
            tutor.cargarProgreso();
            tutor.agregarExperiencia({titulo_real: "Aventura de la Tejedora", palabras: 150});

            // Registrar aventura completada
            const aventurasCompletadas = localStorage.getItem('aventuras-completadas') ?
                JSON.parse(localStorage.getItem('aventuras-completadas')) : [];
            if (!aventurasCompletadas.includes('Barquero')) {
                aventurasCompletadas.push('Barquero');
                localStorage.setItem('aventuras-completadas', JSON.stringify(aventurasCompletadas));
            }

        }

    
        // SISTEMA DE NOTIFICACIONES
        function mostrarNotificacion(mensaje, tipo = 'info') {
            const contenedor = document.getElementById('notificaciones');
            if (!contenedor) return;
            
            const colores = {
                'exito': '#4ecdc4',
                'error': '#ff6b6b', 
                'info': '#feca57',
                'magia': '#a78bfa'
            };
            
            const notificacion = document.createElement('div');
            notificacion.style.cssText = `
                background: linear-gradient(135deg, ${colores[tipo]}, ${colores[tipo]}80);
                color: white;
                padding: 15px 20px;
                border-radius: 15px;
                margin-bottom: 10px;
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255,255,255,0.2);
                animation: deslizarEntrada 0.5s ease-out;
                max-width: 400px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            `;
            
            notificacion.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2em;">${mensaje.split(' ')[0]}</span>
                    <span>${mensaje.slice(mensaje.indexOf(' ') + 1)}</span>
                </div>
            `;
            
            contenedor.appendChild(notificacion);
            
            // Auto-eliminar despu√©s de 5 segundos
            setTimeout(() => {
                notificacion.style.animation = 'deslizarSalida 0.5s ease-in forwards';
                setTimeout(() => {
                    if (notificacion.parentNode) {
                        notificacion.parentNode.removeChild(notificacion);
                    }
                }, 500);
            }, 5000);
        }
    
        // SISTEMA DE MENSAJES DEL NI√ëO
        function actualizarMensajeNi√±o() {
            const mensajes = [
                "‚ú® 'Cada cuento es una puerta a un mundo m√°gico...'",
                "üë∂ '¬°Los filtros funcionan! Puedo encontrar cualquier cuento que imagine...'", 
                "üîÆ 'La biblioteca est√° llena de universos por explorar...'",
                "üí´ 'Me encanta c√≥mo los cuentos se organizan solos...'",
                "üé≠ 'Cada aventura interactiva me hace m√°s valiente...'",
                "üìö '33 cuentos son 33 mundos diferentes para so√±ar...'",
                "üåå 'El Faro Cu√°ntico es mi lugar favorito...'"
            ];
            
            const elemento = document.getElementById('mensaje-ni√±o');
            if (elemento) {
                const mensajeAleatorio = mensajes[Math.floor(Math.random() * mensajes.length)];
                elemento.textContent = mensajeAleatorio;
            }
        }
    
        // ===========================================
        // SISTEMA DE FAVORITOS M√ÅGICOS
        // ===========================================
        
        function mostrarFavoritos() {
            const favoritos = JSON.parse(localStorage.getItem('favoritos-cuanticos')) || [];
            
            if (favoritos.length === 0) {
                return `
                    <div class="tarjeta-cuantica" style="text-align: center; border-color: var(--color-sabiduria);">
                        <div style="font-size: 4em; margin-bottom: 20px;">‚≠ê</div>
                        <h3 style="color: var(--color-sabiduria);">Tus Cuentos Favoritos</h3>
                        <p>A√∫n no tienes cuentos favoritos. ¬°Haz clic en ‚≠ê en cualquier cuento para agregarlo!</p>
                        <button class="boton-accion" onclick="cambiarModulo('biblioteca')" 
                                style="margin-top: 15px; background: linear-gradient(135deg, var(--color-sabiduria), var(--color-purpura));">
                            üìö Explorar Biblioteca
                        </button>
                    </div>
                `;
            }
            
            let html = `
                <div class="tarjeta-cuantica" style="border-color: var(--color-sabiduria);">
                    <div style="display: flex; align-items: center; justify-content: between; margin-bottom: 20px;">
                        <h3 style="color: var(--color-sabiduria); margin: 0;">‚≠ê Tus Cuentos Favoritos</h3>
                        <span style="background: var(--color-sabiduria); color: #0f0c29; padding: 5px 12px; border-radius: 15px; font-weight: bold;">
                            ${favoritos.length}
                        </span>
                    </div>
                    <div class="grid-cuentos">
            `;
            
            favoritos.forEach(tituloOriginal => {
                const cuento = cuentosRealesCompletos.find(c => c.titulo_real === tituloOriginal);
                if (cuento) {
                    const tituloLimpio = cuento.titulo_real.replace(/\*\*/g, '');
                    const contenidoPreview = cuento.contenido ? 
                        cuento.contenido.substring(0, 120).replace(/\*\*/g, '') + '...' : 
                        '‚ú® Este cuento espera ser le√≠do...';
                    
                    html += `
                        <div class="cuento-card" style="border-left: 5px solid var(--color-sabiduria);">
                            <h4>‚≠ê ${tituloLimpio}</h4>
                            <p>üìä ${cuento.palabras} palabras | üè∑Ô∏è ${cuento.categoria}</p>
                            
                            ${cuento.temas && cuento.temas.length > 0 ? `
                                <div style="margin: 10px 0;">
                                    ${cuento.temas.map(tema => `
                                        <span style="background: rgba(254,202,87,0.3); padding: 4px 8px; border-radius: 10px; font-size: 0.8em; margin: 2px; display: inline-block;">
                                            ${tema}
                                        </span>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin: 12px 0; font-size: 0.9em; line-height: 1.4;">
                                <p style="opacity: 0.8; font-style: italic;">${contenidoPreview}</p>
                            </div>
                            
                            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="boton-accion" onclick="leerCuentoCompleto('${cuento.titulo_real}')"
                                        style="padding: 10px 16px; font-size: 14px; background: linear-gradient(135deg, var(--color-agua), var(--color-tiempo));">
                                    üìñ Leer
                                </button>
                                <button class="boton-accion" onclick="quitarDeFavoritos('${cuento.titulo_real}')"
                                        style="padding: 10px 16px; font-size: 14px; background: linear-gradient(135deg, #ff6b6b, #ff8e8e);">
                                    ‚ùå Quitar
                                </button>
                            </div>
                        </div>
                    `;
                }
            });
            
            html += `
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="boton-accion" onclick="limpiarTodosFavoritos()" 
                                style="background: linear-gradient(135deg, #ff6b6b, #ff8e8e);">
                            üóëÔ∏è Limpiar Todos los Favoritos
                        </button>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function quitarDeFavoritos(tituloOriginal) {
            let favoritos = JSON.parse(localStorage.getItem('favoritos-cuanticos')) || [];
            favoritos = favoritos.filter(titulo => titulo !== tituloOriginal);
            localStorage.setItem('favoritos-cuanticos', JSON.stringify(favoritos));
            
            const cuento = cuentosRealesCompletos.find(c => c.titulo_real === tituloOriginal);
            const tituloLimpio = cuento ? cuento.titulo_real.replace(/\*\*/g, '') : tituloOriginal.replace(/\*\*/g, '');
            
            mostrarNotificacion(`‚ùå "${tituloLimpio}" quitado de favoritos`, 'info');
            
            // ‚úÖ NUEVO: Actualizar contador
            actualizarContadorFavoritos();
    
            // Actualizar la vista si estamos en el m√≥dulo de tutor
            if (moduloActual === 'tutor') {
                actualizarVistaFavoritos();
            }
        }
        
        function limpiarTodosFavoritos() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar TODOS tus cuentos favoritos?')) {
                localStorage.removeItem('favoritos-cuanticos');
                mostrarNotificacion('üóëÔ∏è Todos los favoritos han sido eliminados', 'info');
               
                // ‚úÖ NUEVO: Actualizar contador
                actualizarContadorFavoritos();
 
                if (moduloActual === 'tutor') {
                    actualizarVistaFavoritos();
                }
            }
        }
        
        function actualizarVistaFavoritos() {
            const favoritosContainer = document.getElementById('favoritos-contenedor');
            if (favoritosContainer) {
                favoritosContainer.innerHTML = mostrarFavoritos();
            }
        }

        function actualizarContadorFavoritos() {
            const favoritos = JSON.parse(localStorage.getItem('favoritos-cuanticos')) || [];
            const botonTutor = document.querySelector('[onclick*="tutor"]');
            
            if (botonTutor && favoritos.length > 0) {
                // Buscar el span del contador o crearlo
                let contador = botonTutor.querySelector('.contador-favoritos');
                if (!contador) {
                    contador = document.createElement('span');
                    contador.className = 'contador-favoritos';
                    contador.style.cssText = 'background: var(--color-sabiduria); color: #0f0c29; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 5px;';
                    botonTutor.appendChild(contador);
                }
                contador.textContent = `${favoritos.length}‚≠ê`;
            } else if (botonTutor) {
                // Remover contador si no hay favoritos
                const contador = botonTutor.querySelector('.contador-favoritos');
                if (contador) {
                    contador.remove();
                }
            }
        }


        // ===========================================
        // SISTEMA DE LOGROS M√ÅGICOS
        // ===========================================
        
        function calcularLogros() {
            const tutor = new TutorCuantico();
            tutor.cargarProgreso();
            const favoritos = JSON.parse(localStorage.getItem('favoritos-cuanticos')) || [];
            
            const logros = [];
            
            // LOGRO 1: Primer cuento le√≠do
            if (tutor.cuentosLeidos.length >= 1) {
                logros.push({
                    icono: 'üìñ',
                    nombre: 'Iniciador de Sue√±os',
                    descripcion: 'Le√≠ste tu primer cuento m√°gico',
                    nivel: 'bronce',
                    desbloqueado: true
                });
            }
            
            // LOGRO 2: Lector √°vido
            if (tutor.cuentosLeidos.length >= 5) {
                logros.push({
                    icono: 'üìö',
                    nombre: 'Lector √Åvido',
                    descripcion: 'Completaste 5 cuentos m√°gicos',
                    nivel: 'plata',
                    desbloqueado: true
                });
            }
            
            // LOGRO 3: Experto en cuentos
            if (tutor.cuentosLeidos.length >= 10) {
                logros.push({
                    icono: 'üèÜ',
                    nombre: 'Experto en Cuentos',
                    descripcion: 'Completaste 10 cuentos m√°gicos',
                    nivel: 'oro',
                    desbloqueado: true
                });
            }
            
            // LOGRO 4: Coleccionista de favoritos
            if (favoritos.length >= 3) {
                logros.push({
                    icono: '‚≠ê',
                    nombre: 'Coleccionista de Estrellas',
                    descripcion: 'Tienes 3 cuentos favoritos',
                    nivel: 'plata',
                    desbloqueado: true
                });
            }
            
            // LOGRO 5: Amante de los favoritos
            if (favoritos.length >= 7) {
                logros.push({
                    icono: 'üí´',
                    nombre: 'Amante de la Magia',
                    descripcion: 'Tienes 7 cuentos favoritos',
                    nivel: 'oro',
                    desbloqueado: true
                });
            }
            
            // LOGRO 6: Nivel 2 alcanzado
            if (tutor.nivel >= 2) {
                logros.push({
                    icono: 'üöÄ',
                    nombre: 'Explorador Nivel 2',
                    descripcion: 'Alcanzaste el nivel 2 de experiencia',
                    nivel: 'plata',
                    desbloqueado: true
                });
            }
            
            // LOGRO 7: Nivel 5 alcanzado
            if (tutor.nivel >= 5) {
                logros.push({
                    icono: 'üåü',
                    nombre: 'Maestro Nivel 5',
                    descripcion: 'Alcanzaste el nivel 5 de experiencia',
                    nivel: 'oro',
                    desbloqueado: true
                });
            }
            
            // LOGRO 8: Aventurero completo
            const aventurasCompletadas = localStorage.getItem('aventuras-completadas') ? 
                JSON.parse(localStorage.getItem('aventuras-completadas')) : [];
            
            if (aventurasCompletadas.length >= 1) {
                logros.push({
                    icono: 'üé≠',
                    nombre: 'Aventurero Valiente',
                    descripcion: 'Completaste una aventura interactiva',
                    nivel: 'bronce',
                    desbloqueado: true
                });
            }
            
            if (aventurasCompletadas.length >= 3) {
                logros.push({
                    icono: '‚öîÔ∏è',
                    nombre: 'H√©roe de Aventuras',
                    descripcion: 'Completaste las 3 aventuras interactivas',
                    nivel: 'oro',
                    desbloqueado: true
                });
            }
            
            // LOGROS PENDIENTES (para motivar)
            if (tutor.cuentosLeidos.length < 5) {
                logros.push({
                    icono: 'üìñ',
                    nombre: 'Lector en Formaci√≥n',
                    descripcion: 'Lee 5 cuentos para desbloquear',
                    nivel: 'pendiente',
                    desbloqueado: false,
                    progreso: `${tutor.cuentosLeidos.length}/5`
                });
            }
            
            if (favoritos.length < 3) {
                logros.push({
                    icono: '‚≠ê',
                    nombre: 'Buscador de Estrellas',
                    descripcion: 'Agrega 3 cuentos a favoritos',
                    nivel: 'pendiente',
                    desbloqueado: false,
                    progreso: `${favoritos.length}/3`
                });
            }
            
            if (aventurasCompletadas.length < 3) {
                logros.push({
                    icono: 'üé≠',
                    nombre: 'Explorador de Mundos',
                    descripcion: 'Completa las 3 aventuras interactivas',
                    nivel: 'pendiente',
                    desbloqueado: false,
                    progreso: `${aventurasCompletadas.length}/3`
                });
            }
            
            return logros;
        }
        
       
        function mostrarLogros() {
            const logros = calcularLogros();
            const logrosDesbloqueados = logros.filter(l => l.desbloqueado);
            const logrosPendientes = logros.filter(l => !l.desbloqueado);
            
            let html = '';
            
            // Mostrar progreso general
            html += `
                <div style="text-align: center; margin-bottom: 25px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 15px;">
                    <h4 style="color: var(--color-sabiduria); margin-bottom: 10px;">Tu Progreso M√°gico</h4>
                    <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                        <span>üèÜ ${logrosDesbloqueados.length} logros</span>
                        <span>‚≠ê ${logrosPendientes.length} por alcanzar</span>
                    </div>
                </div>
            `;
            
            // Logros desbloqueados
            if (logrosDesbloqueados.length > 0) {
                html += `<h4 style="color: var(--color-sabiduria); margin: 25px 0 15px 0;">‚ú® Logros Desbloqueados</h4>`;
                
                logrosDesbloqueados.forEach(logro => {
                    const colorNivel = {
                        'bronce': '#cd7f32',
                        'plata': '#c0c0c0',
                        'oro': '#ffd700'
                    }[logro.nivel] || '#feca57'; // Color por defecto
                    
                    html += `
                        <div class="logro" style="border-color: ${colorNivel};">
                            <div class="logro-icono" style="background: ${colorNivel};">
                                ${logro.icono}
                            </div>
                            <div style="flex: 1;">
                                <strong style="color: ${colorNivel};">${logro.nombre}</strong>
                                <p style="margin: 5px 0; opacity: 0.9;">${logro.descripcion}</p>
                                <div style="font-size: 0.8em; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px;">
                                    ${logro.nivel}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            // Logros pendientes
            if (logrosPendientes.length > 0) {
                html += `<h4 style="color: var(--color-purpura); margin: 30px 0 15px 0;">üéØ Pr√≥ximos Desaf√≠os</h4>`;
                
                logrosPendientes.forEach(logro => {
                    html += `
                        <div class="logro" style="border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.02); opacity: 0.7;">
                            <div class="logro-icono" style="background: rgba(255,255,255,0.2);">
                                ${logro.icono}
                            </div>
                            <div style="flex: 1;">
                                <strong>${logro.nombre}</strong>
                                <p style="margin: 5px 0; opacity: 0.8;">${logro.descripcion}</p>
                                <div style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 10px; font-size: 0.8em; display: inline-block;">
                                    ${logro.progreso}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            if (logros.length === 0) {
                html = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">üîÆ</div>
                        <p>Los logros aparecer√°n aqu√≠ a medida que explores el Faro Cu√°ntico.</p>
                        <button class="boton-accion" onclick="cambiarModulo('biblioteca')" 
                                style="margin-top: 15px; background: linear-gradient(135deg, var(--color-agua), var(--color-tiempo));">
                            üìö Comenzar a Explorar
                        </button>
                    </div>
                `;
            }
            
            return html;
        }
 
        // ===========================================
        // SISTEMA DE RECOMENDACIONES INTELIGENTES
        // ===========================================
        
        function generarRecomendaciones() {
            const tutor = new TutorCuantico();
            tutor.cargarProgreso();
            const favoritos = JSON.parse(localStorage.getItem('favoritos-cuanticos')) || [];
            const aventurasCompletadas = localStorage.getItem('aventuras-completadas') ? 
                JSON.parse(localStorage.getItem('aventuras-completadas')) : [];
            
            const recomendaciones = [];
            
            // RECOMENDACI√ìN 1: Si no ha le√≠do ning√∫n cuento
            if (tutor.cuentosLeidos.length === 0) {
                recomendaciones.push({
                    tipo: 'inicio',
                    titulo: 'El Faro',
                    descripcion: 'Comienza con el cuento que da nombre a nuestro universo',
                    motivo: 'Perfecto para empezar tu viaje m√°gico',
                    accion: 'leerCuentoCompleto',
                    parametro: 'El Faro'
                });
            }
            
            // RECOMENDACI√ìN 2: Basado en favoritos
            if (favoritos.length > 0) {
                // Encontrar categor√≠as de favoritos
                const categoriasFavoritas = [];
                favoritos.forEach(titulo => {
                    const cuento = cuentosRealesCompletos.find(c => c.titulo_real === titulo);
                    if (cuento) {
                        categoriasFavoritas.push(cuento.categoria);
                    }
                });
                
                // Recomendar cuentos de categor√≠as similares no le√≠dos
                const categoriaMasFrecuente = categoriasFavoritas.sort((a, b) =>
                    categoriasFavoritas.filter(v => v === a).length -
                    categoriasFavoritas.filter(v => v === b).length
                ).pop();
                
                if (categoriaMasFrecuente) {
                    const cuentoRecomendado = cuentosRealesCompletos.find(c => 
                        c.categoria === categoriaMasFrecuente && 
                        !tutor.cuentosLeidos.includes(c.titulo_real) &&
                        !favoritos.includes(c.titulo_real)
                    );
                    
                    if (cuentoRecomendado) {
                        recomendaciones.push({
                            tipo: 'similar',
                            titulo: cuentoRecomendado.titulo_real.replace(/\*\*/g, ''),
                            descripcion: `Te puede gustar por tu inter√©s en ${categoriaMasFrecuente}`,
                            motivo: 'Basado en tus favoritos',
                            accion: 'leerCuentoCompleto',
                            parametro: cuentoRecomendado.titulo_real
                        });
                    }
                }
            }
            
            // RECOMENDACI√ìN 3: Cuentos populares (m√°s palabras)
            const cuentoExtenso = cuentosRealesCompletos
                .filter(c => !tutor.cuentosLeidos.includes(c.titulo_real))
                .sort((a, b) => b.palabras - a.palabras)[0];
            
            if (cuentoExtenso && tutor.cuentosLeidos.length >= 3) {
                recomendaciones.push({
                    tipo: 'extenso',
                    titulo: cuentoExtenso.titulo_real.replace(/\*\*/g, ''),
                    descripcion: `Una historia √©pica de ${cuentoExtenso.palabras} palabras`,
                    motivo: 'Para lectores avanzados',
                    accion: 'leerCuentoCompleto',
                    parametro: cuentoExtenso.titulo_real
                });
            }
            
            // RECOMENDACI√ìN 4: Aventuras interactivas no completadas
            const aventurasDisponibles = ['Barquero', 'Tejedora', 'Faro'];
            const aventuraNoCompletada = aventurasDisponibles.find(aventura => 
                !aventurasCompletadas.includes(aventura)
            );
            
            if (aventuraNoCompletada) {
                recomendaciones.push({
                    tipo: 'aventura',
                    titulo: `Aventura del ${aventuraNoCompletada}`,
                    descripcion: 'Donde tus decisiones cambian la historia',
                    motivo: '¬°Gana experiencia extra!',
                    accion: `iniciarAventura${aventuraNoCompletada}`,
                    parametro: null
                });
            }
            
            // RECOMENDACI√ìN 5: Cuentos cortos para empezar
            if (tutor.cuentosLeidos.length < 3) {
                const cuentoCorto = cuentosRealesCompletos
                    .filter(c => !tutor.cuentosLeidos.includes(c.titulo_real))
                    .sort((a, b) => a.palabras - b.palabras)[0];
                
                if (cuentoCorto && cuentoCorto.palabras < 300) {
                    recomendaciones.push({
                        tipo: 'corto',
                        titulo: cuentoCorto.titulo_real.replace(/\*\*/g, ''),
                        descripcion: `Una historia breve de ${cuentoCorto.palabras} palabras`,
                        motivo: 'Ideal para comenzar',
                        accion: 'leerCuentoCompleto',
                        parametro: cuentoCorto.titulo_real
                    });
                }
            }
            
            // RECOMENDACI√ìN 6: Si tiene muchos favoritos, sugerir explorar nuevos
            if (favoritos.length >= 5) {
                const cuentoNuevoCategoria = cuentosRealesCompletos.find(c => {
                    const categoriasFavoritas = favoritos.map(titulo => {
                        const cuentoFav = cuentosRealesCompletos.find(cf => cf.titulo_real === titulo);
                        return cuentoFav ? cuentoFav.categoria : null;
                    }).filter(Boolean);
                    
                    return !categoriasFavoritas.includes(c.categoria) && 
                           !tutor.cuentosLeidos.includes(c.titulo_real);
                });
                
                if (cuentoNuevoCategoria) {
                    recomendaciones.push({
                        tipo: 'diversidad',
                        titulo: cuentoNuevoCategoria.titulo_real.replace(/\*\*/g, ''),
                        descripcion: `Explora la categor√≠a ${cuentoNuevoCategoria.categoria}`,
                        motivo: 'Ampl√≠a tus horizontes m√°gicos',
                        accion: 'leerCuentoCompleto',
                        parametro: cuentoNuevoCategoria.titulo_real
                    });
                }
            }
            
            return recomendaciones.slice(0, 3); // M√°ximo 3 recomendaciones
        }
        
        function mostrarRecomendaciones() {
            const recomendaciones = generarRecomendaciones();
            
            if (recomendaciones.length === 0) {
                return `
                    <div style="text-align: center; padding: 30px;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üîç</div>
                        <p>Explora m√°s cuentos para recibir recomendaciones personalizadas.</p>
                        <button class="boton-accion" onclick="cambiarModulo('biblioteca')" 
                                style="margin-top: 15px; background: linear-gradient(135deg, var(--color-agua), var(--color-tiempo));">
                            üìö Ir a la Biblioteca
                        </button>
                    </div>
                `;
            }
            
            let html = '<div class="grid-cuentos">';
            
            recomendaciones.forEach((rec, index) => {
                const colores = {
                    'inicio': 'linear-gradient(135deg, var(--color-sabiduria), var(--color-purpura))',
                    'similar': 'linear-gradient(135deg, var(--color-agua), var(--color-tiempo))',
                    'extenso': 'linear-gradient(135deg, var(--color-magico), var(--color-rosa))',
                    'aventura': 'linear-gradient(135deg, var(--color-purpura), var(--color-rosa))',
                    'corto': 'linear-gradient(135deg, var(--color-sue√±o), var(--color-agua))',
                    'diversidad': 'linear-gradient(135deg, #ff9a56, #ff6b6b)'
                };
                
                const iconos = {
                    'inicio': 'üåü',
                    'similar': 'üíñ', 
                    'extenso': 'üèÜ',
                    'aventura': 'üé≠',
                    'corto': '‚ö°',
                    'diversidad': 'üåà'
                };
                
                html += `
                    <div class="cuento-card" style="border-left: 5px solid; border-image: ${colores[rec.tipo]} 1;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 1.5em;">${iconos[rec.tipo]}</span>
                            <h4>${rec.titulo}</h4>
                        </div>
                        <p>${rec.descripcion}</p>
                        <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 0.9em;">
                            <strong>üí° ${rec.motivo}</strong>
                        </div>
                        <button class="boton-accion" onclick="${rec.accion}(${rec.parametro ? `'${rec.parametro}'` : ''})" 
                                style="padding: 10px 20px; font-size: 14px; background: ${colores[rec.tipo]};">
                            ${rec.tipo === 'aventura' ? 'üé≠ Comenzar Aventura' : 'üìñ Leer Ahora'}
                        </button>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // ===========================================
        // SISTEMA DE NAVEGACI√ìN RESPONSIVE
        // ===========================================

        // MEJORAR SISTEMA DE MEN√ö M√ìVIL
        let menuAbierto = false;
        
        function toggleMenu() {
            const menuMovil = document.getElementById('menuMovil');
            const hamburguesa = document.querySelector('.boton-hamburguesa');
            const overlay = document.querySelector('.overlay-menu');
            
            menuAbierto = !menuAbierto;
            
            if (menuAbierto) {
                menuMovil.classList.add('active');
                hamburguesa.classList.add('active');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            } else {
                menuMovil.classList.remove('active');
                hamburguesa.classList.remove('active');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        // Cerrar men√∫ al hacer clic en overlay
        document.addEventListener('click', function(event) {
            const overlay = document.querySelector('.overlay-menu');
            if (menuAbierto && event.target === overlay) {
                toggleMenu();
            }
        });
        
        // Cerrar men√∫ con tecla ESC
        document.addEventListener('keydown', function(event) {
            if (menuAbierto && event.key === 'Escape') {
                toggleMenu();
            }
        });
        
        // Manejar bot√≥n de retroceso del navegador
        window.addEventListener('popstate', function(event) {
            if (menuAbierto) {
                toggleMenu();
                // Prevenir que la p√°gina se cierre
                history.pushState(null, null, window.location.href);
            }
        });
        
        function crearOverlay() {
            const overlay = document.createElement('div');
            overlay.className = 'overlay-menu';
            overlay.onclick = toggleMenu;
            document.body.appendChild(overlay);
            return overlay;
        }
        
        // FUNCI√ìN MEJORADA PARA CAMBIAR M√ìDULO DESDE M√ìVIL
        function cambiarModuloMovil(modulo) {
            console.log("üì± Cambiando a m√≥dulo desde m√≥vil:", modulo);
            
            // 1. Cerrar el men√∫ m√≥vil primero
            toggleMenu();
            
            // 2. Peque√±o delay para que se vea la animaci√≥n de cierre
            setTimeout(() => {
                // 3. Cambiar al m√≥dulo seleccionado
                cambiarModulo(modulo);
                
                // 4. Actualizar botones activos en el men√∫ m√≥vil
                actualizarBotonesActivosMovil(modulo);
                
                console.log("‚úÖ Navegaci√≥n m√≥vil completada a:", modulo);
            }, 300);
        }
        
        // FUNCI√ìN PARA ACTUALIZAR BOTONES ACTIVOS EN M√ìVIL
        function actualizarBotonesActivosMovil(moduloActivo) {
            const botonesMovil = document.querySelectorAll('.boton-modulo-movil');
            
            botonesMovil.forEach(boton => {
                boton.classList.remove('activo');
                
                // Verificar a qu√© m√≥dulo apunta este bot√≥n
                const onclick = boton.getAttribute('onclick');
                if (onclick && onclick.includes(`'${moduloActivo}'`)) {
                    boton.classList.add('activo');
                }
            });
        }
        
        // ACTUALIZAR TAMBI√âN LA FUNCI√ìN cambiarModulo ORIGINAL
        function cambiarModulo(modulo, event = null) {
            if (event) event.preventDefault();
            
            console.log("üîÑ Cambiando a m√≥dulo:", modulo);
            
            // Ocultar m√≥dulo actual
            document.querySelectorAll('.modulo').forEach(m => {
                m.classList.remove('activo');
            });
            
            // Mostrar nuevo m√≥dulo
            const moduloElement = document.getElementById(modulo);
            if (moduloElement) {
                moduloElement.classList.add('activo');
                console.log("‚úÖ M√≥dulo activado:", modulo);
            } else {
                console.error("‚ùå M√≥dulo no encontrado:", modulo);
                return;
            }
            
            // Actualizar botones activos en desktop
            document.querySelectorAll('.boton-modulo').forEach(b => {
                b.classList.remove('activo');
            });
            
            const botonDesktop = document.querySelector(`.menu-desktop [onclick*="${modulo}"]`);
            if (botonDesktop) {
                botonDesktop.classList.add('activo');
            }
            
            // Actualizar botones activos en m√≥vil
            actualizarBotonesActivosMovil(modulo);
            
            moduloActual = modulo;
            
            // Cargar contenido espec√≠fico del m√≥dulo
            switch(modulo) {
                case 'biblioteca':
                    cargarBibliotecaInteractiva();
                    break;
                case 'analizador':
                    cargarAnalizadorProfundo();
                    break;
                case 'tutor':
                    actualizarPerfilTutor();
                    break;
            }
            
            mostrarNotificacion(`üåå Cambiando a ${obtenerNombreModulo(modulo)}`, 'info');
            
            // Actualizar URL
            history.pushState({ modulo: modulo }, '', `#${modulo}`);
        }       

        // FUNCI√ìN DE DEBUG PARA VERIFICAR EL MEN√ö M√ìVIL
        function debugMenuMovil() {
            console.log("üîç DEBUG MEN√ö M√ìVIL:");
            
            const menuMovil = document.getElementById('menuMovil');
            const botones = document.querySelectorAll('.boton-modulo-movil');
            
            console.log("Menu m√≥vil existe:", !!menuMovil);
            console.log("Botones encontrados:", botones.length);
            
            botones.forEach((boton, index) => {
                const onclick = boton.getAttribute('onclick');
                console.log(`Bot√≥n ${index}:`, {
                    texto: boton.textContent.trim(),
                    onclick: onclick,
                    activo: boton.classList.contains('activo')
                });
            });
        }

        // Cerrar men√∫ al hacer clic fuera
        document.addEventListener('click', function(event) {
            const menuMovil = document.getElementById('menuMovil');
            const hamburguesa = document.querySelector('.boton-hamburguesa');
            
            if (menuAbierto && 
                !menuMovil.contains(event.target) && 
                !hamburguesa.contains(event.target)) {
                toggleMenu();
            }
        });
        
        // Cerrar men√∫ con tecla ESC
        document.addEventListener('keydown', function(event) {
            if (menuAbierto && event.key === 'Escape') {
                toggleMenu();
            }
        });
        
        // Actualizar contador de favoritos tambi√©n en m√≥viles
        function actualizarContadorFavoritos() {
            const favoritos = JSON.parse(localStorage.getItem('favoritos-cuanticos')) || [];
            const botonTutorDesktop = document.querySelector('.menu-desktop [onclick*="tutor"]');
            const botonTutorMovil = document.querySelector('.menu-movil [onclick*="tutor"]');
            
            // Actualizar desktop
            if (botonTutorDesktop && favoritos.length > 0) {
                let contador = botonTutorDesktop.querySelector('.contador-favoritos');
                if (!contador) {
                    contador = document.createElement('span');
                    contador.className = 'contador-favoritos';
                    contador.style.cssText = 'background: var(--color-sabiduria); color: #0f0c29; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 5px;';
                    botonTutorDesktop.appendChild(contador);
                }
                contador.textContent = `${favoritos.length}‚≠ê`;
            }
            
            // Actualizar m√≥vil
            if (botonTutorMovil && favoritos.length > 0) {
                let contador = botonTutorMovil.querySelector('.contador-favoritos');
                if (!contador) {
                    contador = document.createElement('span');
                    contador.className = 'contador-favoritos';
                    contador.style.cssText = 'background: var(--color-sabiduria); color: #0f0c29; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 10px; float: right;';
                    botonTutorMovil.appendChild(contador);
                }
                contador.textContent = `${favoritos.length}‚≠ê`;
            }
        }

        // ESTILOS DIN√ÅMICOS PARA ANIMACIONES
        const style = document.createElement('style');
        style.textContent = `
            @keyframes deslizarEntrada {
                from { 
                    transform: translateX(100%); 
                    opacity: 0; 
                }
                to { 
                    transform: translateX(0); 
                    opacity: 1; 
                }
            }
            
            @keyframes deslizarSalida {
                from { 
                    transform: translateX(0); 
                    opacity: 1; 
                }
                to { 
                    transform: translateX(100%); 
                    opacity: 0; 
                }
            }

            .analisis-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 0;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                transition: all 0.3s ease;
            }

            .analisis-item:hover {
                background: rgba(255,255,255,0.05);
                border-radius: 10px;
                padding: 12px 15px;
                margin: 0 -15px;
            }

            .contador-analisis {
                background: var(--color-magico);
                padding: 4px 12px;
                border-radius: 15px;
                font-size: 0.9em;
                font-weight: bold;
            }
        `;
        document.head.appendChild(style);

        // ==================================================
        // üõ†Ô∏è FUNCIONES AUXILIARES GLOBALES (COLOCAR AL INICIO DEL JS)
        // ==================================================
        
        // FUNCI√ìN PARA LIMPIAR EVENT LISTENERS
        function limpiarEventListenersMovil() {
            console.log("üßπ Limpiando event listeners m√≥viles...");
            
            if (window.eventListeners && window.eventListeners.movil) {
                window.eventListeners.movil.forEach((listener, index) => {
                    if (listener.element && listener.handler) {
                        listener.element.removeEventListener(listener.type, listener.handler);
                    }
                });
                window.eventListeners.movil = [];
            }
            
            console.log("‚úÖ Event listeners m√≥viles limpiados");
        }
        
        // FUNCI√ìN DE VERIFICACI√ìN DEL ESTADO DEL MEN√ö
        function verificarEstadoMenu() {
            if (!window.eventListeners) return;
            
            const botones = document.querySelectorAll('.boton-modulo-movil');
            let botonesFuncionales = 0;
            
            botones.forEach(boton => {
                // Verificaci√≥n simple - si el bot√≥n existe y es clickeable
                const estilo = window.getComputedStyle(boton);
                const esClickeable = estilo.pointerEvents !== 'none' && 
                                    estilo.opacity !== '0' && 
                                    boton.offsetParent !== null;
                
                if (esClickeable) {
                    botonesFuncionales++;
                } else {
                    console.warn(`‚ö†Ô∏è Bot√≥n no clickeable: ${boton.textContent.trim()}`);
                }
            });
            
            console.log(`üîç Monitoreo: ${botonesFuncionales}/${botones.length} botones funcionales`);
            
            // Si hay menos de 3 botones funcionales, reconfigurar
            if (botonesFuncionales < 3 && !window.reconfigurandoMenu) {
                console.warn("üîÑ Reconfigurando men√∫ m√≥vil por estado cr√≠tico...");
                reconfigurarMenuMovil();
            }
            
            return botonesFuncionales;
        }
        
        // FUNCI√ìN DE RECONFIGURACI√ìN DE EMERGENCIA
        function reconfigurarMenuMovil() {
            if (window.reconfigurandoMenu) return;
            
            window.reconfigurandoMenu = true;
            console.log("üîÑ INICIANDO RECONFIGURACI√ìN DE EMERGENCIA DEL MEN√ö");
            
            // Limpiar event listeners antiguos
            limpiarEventListenersMovil();
            
            // Reconfigurar botones
            const botones = document.querySelectorAll('.boton-modulo-movil');
            botones.forEach((boton, index) => {
                const handler = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const texto = this.textContent.trim();
                    let modulo = '';
                    
                    if (texto.includes('Dashboard')) modulo = 'dashboard';
                    else if (texto.includes('Biblioteca')) modulo = 'biblioteca';
                    else if (texto.includes('Analizador')) modulo = 'analizador';
                    else if (texto.includes('Interactivo')) modulo = 'interactivo';
                    else if (texto.includes('Aprendizaje')) modulo = 'tutor';
                    
                    if (modulo) {
                        console.log(`üöÄ RECONFIGURADO - Navegando a: ${modulo}`);
                        cambiarModuloMovil(modulo);
                    }
                };
                
                boton.addEventListener('click', handler);
                
                // Guardar en el sistema de gesti√≥n
                if (!window.eventListeners) window.eventListeners = { movil: [], global: [] };
                window.eventListeners.movil.push({ element: boton, type: 'click', handler: handler });
            });
            
            console.log(`üéâ RECONFIGURACI√ìN COMPLETADA: ${botones.length} botones`);
            window.reconfigurandoMenu = false;
            
            // Mostrar notificaci√≥n
            if (typeof mostrarNotificacion === 'function') {
                mostrarNotificacion('üîß Men√∫ reconfigurado', 'info');
            }
        }
        
        // FUNCI√ìN TOGGLE MEN√ö MEJORADA CON VERIFICACI√ìN
        function toggleMenu() {
            // Verificar que los elementos existan
            const menuMovil = document.getElementById('menuMovil');
            const hamburguesa = document.querySelector('.boton-hamburguesa');
            const overlay = document.querySelector('.overlay-menu');
            
            if (!menuMovil || !hamburguesa || !overlay) {
                console.error("‚ùå Elementos del men√∫ no encontrados");
                return;
            }
            
            menuAbierto = !menuAbierto;
            
            if (menuAbierto) {
                // ABRIR MEN√ö
                menuMovil.classList.add('active');
                hamburguesa.classList.add('active');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                console.log("üì± Men√∫ ABIERTO correctamente");
            } else {
                // CERRAR MEN√ö
                menuMovil.classList.remove('active');
                hamburguesa.classList.remove('active');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
                
                console.log("üì± Men√∫ CERRADO correctamente");
            }
        }
        
        // FUNCI√ìN CAMBIAR M√ìDULO DESDE M√ìVIL MEJORADA
        function cambiarModuloMovil(modulo) {
            console.log(`üéØ NAVEGACI√ìN M√ìVIL INICIADA: ${modulo}`);
            
            // Verificar que el m√≥dulo existe
            if (!document.getElementById(modulo)) {
                console.error(`‚ùå M√≥dulo no encontrado: ${modulo}`);
                return;
            }
            
            // Cerrar men√∫ inmediatamente
            if (menuAbierto) {
                console.log("üîí Cerrando men√∫ para navegar...");
                toggleMenu();
            }
            
            // Navegar despu√©s de un delay para la animaci√≥n
            setTimeout(() => {
                console.log(`üöÄ Ejecutando navegaci√≥n a: ${modulo}`);
                cambiarModulo(modulo);
            }, 350);
        }
        
        // ==================================================
        // üåå FARO CU√ÅNTICO - EVENT LISTENER UNIFICADO CORREGIDO
        // ==================================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üåå INICIANDO FARO CU√ÅNTICO - CARGA UNIFICADA CORREGIDA");
            
            // =================================================================
            // üîß BLOQUE 1: CONFIGURACI√ìN INICIAL MEJORADA
            // =================================================================
            console.log("üîß Paso 1: Configuraci√≥n inicial mejorada...");
            
            // Sistema de gesti√≥n de event listeners
            window.eventListeners = {
                movil: [],
                global: []
            };
            
            // Inicializar variables globales con valores por defecto
            window.moduloActual = 'dashboard';
            window.menuAbierto = false;
            window.historialModulos = ['dashboard'];
            window.menuConfigurado = false;
            window.reconfigurandoMenu = false;
        
            // Configurar m√≥dulo desde URL
            const hash = window.location.hash.substring(1);
            if (hash && ['dashboard', 'biblioteca', 'analizador', 'interactivo', 'tutor'].includes(hash)) {
                moduloActual = hash;
                historialModulos = [hash];
            }
            
            // =================================================================
            // üì± BLOQUE 2: CONFIGURACI√ìN ROBUSTA DE MEN√ö M√ìVIL
            // =================================================================
            console.log("üîß Paso 2: Configurando men√∫ m√≥vil robusto...");
            
            // Limpiar event listeners anteriores SI existen
            limpiarEventListenersMovil();
            
            // Crear overlay si no existe
            if (!document.querySelector('.overlay-menu')) {
                const overlay = document.createElement('div');
                overlay.className = 'overlay-menu';
                document.body.appendChild(overlay);
                console.log("‚úÖ Overlay creado");
            }
            
            // Configurar overlay UNA SOLA VEZ
            const overlay = document.querySelector('.overlay-menu');
            overlay.onclick = null; // Limpiar primero
            
            const overlayHandler = function(e) {
                if (e.target === overlay && menuAbierto) {
                    toggleMenu();
                }
            };
            
            overlay.addEventListener('click', overlayHandler);
            eventListeners.global.push({ element: overlay, type: 'click', handler: overlayHandler });
            
            // Configurar botones del men√∫ m√≥vil CON SISTEMA ROBUSTO
            const botonesMovil = document.querySelectorAll('.boton-modulo-movil');
            
            botonesMovil.forEach((boton, index) => {
                const botonHandler = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    const texto = this.textContent.trim();
                    let modulo = '';
                    
                    if (texto.includes('Dashboard')) modulo = 'dashboard';
                    else if (texto.includes('Biblioteca')) modulo = 'biblioteca';
                    else if (texto.includes('Analizador')) modulo = 'analizador';
                    else if (texto.includes('Interactivo')) modulo = 'interactivo';
                    else if (texto.includes('Aprendizaje')) modulo = 'tutor';
                    
                    if (modulo) {
                        console.log(`üöÄ Navegando a: ${modulo} (bot√≥n ${index + 1})`);
                        cambiarModuloMovil(modulo);
                    }
                };
                
                // Usar capture phase para mayor prioridad
                boton.addEventListener('click', botonHandler, { 
                    capture: true,
                    passive: false 
                });
                
                eventListeners.movil.push({ 
                    element: boton, 
                    type: 'click', 
                    handler: botonHandler,
                    options: { capture: true, passive: false }
                });
                
                console.log(`‚úÖ Bot√≥n m√≥vil ${index + 1} configurado: ${boton.textContent.trim()}`);
            });
            
            window.menuConfigurado = true;
            console.log(`üéØ Men√∫ m√≥vil configurado: ${botonesMovil.length} botones`);
        
            // =================================================================
            // üß≠ BLOQUE 3: CONFIGURACI√ìN DE NAVEGACI√ìN MEJORADA
            // =================================================================
            console.log("üîß Paso 3: Configurando navegaci√≥n mejorada...");
            
            // Configurar manejo de popstate
            function manejarPopState(event) {
                console.log("üîô Manejo de popstate...");
                if (menuAbierto) {
                    toggleMenu();
                    history.pushState(null, null, window.location.href);
                } else if (historialModulos.length > 1) {
                    historialModulos.pop();
                    const moduloAnterior = historialModulos[historialModulos.length - 1];
                    cambiarModulo(moduloAnterior);
                }
            }
            
            // Configurar tecla Escape
            function manejarTeclaEscape(event) {
                if (menuAbierto && event.key === 'Escape') {
                    console.log("‚éã Tecla Escape - cerrando men√∫");
                    toggleMenu();
                }
            }
            
            window.addEventListener('popstate', manejarPopState);
            document.addEventListener('keydown', manejarTeclaEscape);
            
            eventListeners.global.push({ element: window, type: 'popstate', handler: manejarPopState });
            eventListeners.global.push({ element: document, type: 'keydown', handler: manejarTeclaEscape });
        
            // =================================================================
            // üìö BLOQUE 4: INICIALIZACI√ìN DE DATOS
            // =================================================================
            console.log("üîß Paso 4: Inicializando biblioteca...");
            
            // Inicializar cuentos y categor√≠as
            if (typeof inicializarCuentosCompletos === 'function') {
                inicializarCuentosCompletos();
            }
            
            if (typeof inicializarCategorias === 'function') {
                inicializarCategorias();
            }
            
            // Cargar estad√≠sticas iniciales
            if (typeof actualizarEstadisticas === 'function') {
                setTimeout(actualizarEstadisticas, 500);
            }
        
            // =================================================================
            // üé® BLOQUE 5: CONFIGURACI√ìN DE INTERFAZ
            // =================================================================
            console.log("üîß Paso 5: Configurando interfaz...");
            
            // Asegurar que el m√≥dulo correcto est√© activo
            setTimeout(() => {
                cambiarModulo(moduloActual);
            }, 100);
            
            // Configurar botones de compartir si existen
            const botonesCompartir = document.querySelectorAll('[onclick*="compartir"]');
            if (botonesCompartir.length > 0) {
                console.log(`‚úÖ ${botonesCompartir.length} botones de compartir detectados`);
            }
        
            // =================================================================
            // üîç BLOQUE 6: SISTEMA DE MONITOREO MEJORADO
            // =================================================================
            console.log("üîß Paso 6: Configurando sistema de monitoreo mejorado...");
            
            // Verificar cada 45 segundos (menos intrusivo)
            setInterval(() => {
                if (window.verificarEstadoMenu) {
                    verificarEstadoMenu();
                }
            }, 45000);
            
            console.log("‚úÖ Sistema de monitoreo configurado (45 segundos)");
        
            // =================================================================
            // ‚úÖ BLOQUE 7: FINALIZACI√ìN MEJORADA
            // =================================================================
            console.log("üîß Paso 7: Finalizando inicializaci√≥n mejorada...");
            
            // Verificaci√≥n final mejorada
            setTimeout(() => {
                console.log("üîç VERIFICACI√ìN FINAL MEJORADA:");
                console.log(`‚úÖ M√≥dulo actual: ${moduloActual}`);
                console.log(`‚úÖ Men√∫ configurado: ${menuConfigurado}`);
                console.log(`‚úÖ Botones m√≥viles: ${document.querySelectorAll('.boton-modulo-movil').length}`);
                console.log(`‚úÖ Listeners activos: ${eventListeners.movil.length} m√≥viles`);
                console.log(`‚úÖ Sistema estable: ${!!window.verificarEstadoMenu}`);
                
                // Verificaci√≥n inicial del men√∫
                if (window.verificarEstadoMenu) {
                    verificarEstadoMenu();
                }
                
                console.log("üéâ FARO CU√ÅNTICO INICIALIZADO CON SISTEMA SUPER ROBUSTO");
                
                // Mostrar notificaci√≥n de bienvenida
                if (typeof mostrarNotificacion === 'function') {
                    mostrarNotificacion('üåå Faro Cu√°ntico listo para la aventura', 'exito');
                }
            }, 3000);
        });
        
        // ==================================================
        // üîÑ FUNCIONES DE NAVEGACI√ìN (MANTENER EXISTENTES)
        // ==================================================
        
        function cambiarModulo(modulo, event = null) {
            if (event) event.preventDefault();
            
            console.log("üîÑ Cambiando a m√≥dulo:", modulo);
            
            // Ocultar m√≥dulo actual
            document.querySelectorAll('.modulo').forEach(m => {
                m.classList.remove('activo');
            });
            
            // Mostrar nuevo m√≥dulo
            const moduloElement = document.getElementById(modulo);
            if (moduloElement) {
                moduloElement.classList.add('activo');
                console.log("‚úÖ M√≥dulo activado:", modulo);
            } else {
                console.error("‚ùå M√≥dulo no encontrado:", modulo);
                return;
            }
            
            // Actualizar botones activos en desktop
            document.querySelectorAll('.boton-modulo').forEach(b => {
                b.classList.remove('activo');
            });
            
            const botonDesktop = document.querySelector(`.menu-desktop [onclick*="${modulo}"]`);
            if (botonDesktop) {
                botonDesktop.classList.add('activo');
            }
            
            // Actualizar botones activos en m√≥vil
            document.querySelectorAll('.boton-modulo-movil').forEach(b => {
                b.classList.remove('activo');
                const onclick = b.getAttribute('onclick');
                if (onclick && onclick.includes(`'${modulo}'`)) {
                    b.classList.add('activo');
                }
            });
            
            // Actualizar historial
            if (modulo !== historialModulos[historialModulos.length - 1]) {
                historialModulos.push(modulo);
            }
            
            moduloActual = modulo;
            
            // Cargar contenido espec√≠fico del m√≥dulo
            switch(modulo) {
                case 'biblioteca':
                    if (typeof cargarBibliotecaInteractiva === 'function') {
                        cargarBibliotecaInteractiva();
                    }
                    break;
                case 'analizador':
                    if (typeof cargarAnalizadorProfundo === 'function') {
                        cargarAnalizadorProfundo();
                    }
                    break;
                case 'tutor':
                    if (typeof actualizarPerfilTutor === 'function') {
                        actualizarPerfilTutor();
                    }
                    break;
            }
            
            // Mostrar notificaci√≥n
            if (typeof mostrarNotificacion === 'function') {
                mostrarNotificacion(`üåå Cambiando a ${obtenerNombreModulo(modulo)}`, 'info');
            }
            
            // Actualizar URL
            history.pushState({ modulo: modulo }, '', `#${modulo}`);
        }
        
        function obtenerNombreModulo(modulo) {
            const nombres = {
                'dashboard': 'Dashboard',
                'biblioteca': 'Biblioteca', 
                'analizador': 'Analizador',
                'interactivo': 'Interactivo',
                'tutor': 'Mi Aprendizaje'
            };
            return nombres[modulo] || modulo;
        }

    </script>
</body>
</html>
